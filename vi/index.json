[{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.2-setup-lambda/7.2.1-create-iam-role-and-policy-for-lambda/","title":"C√†i ƒë·∫∑t IAM Role v√† Policy cho Lambda","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t IAM Role v√† Policy cho Lambda.\nT·∫°o IAM Role cho Lambda M·ªü IAM Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/iam/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí IAM Create Role:\nCh·ªçn t√πy ch·ªçn Role tr√™n menu b√™n tr√°i. Sau ƒë√≥ nh·∫•n Create role. Ch·ªçn trusted entity:\nTrusted entity type: AWS Service Use case: Lambda Nh·∫•n \u0026ldquo;Next\u0026rdquo; ƒê√≠nh k√®m permissions policies:\nTrong h·ªôp t√¨m ki·∫øm, nh·∫≠p AWSLambdaBasicExecutionRole ƒê√°nh d·∫•u √¥ b√™n c·∫°nh \u0026ldquo;AWSLambdaBasicExecutionRole\u0026rdquo; Nh·∫•n \u0026ldquo;Next\u0026rdquo; ƒê·∫∑t t√™n, xem l·∫°i, v√† t·∫°o:\nRole name: Nh·∫≠p dashboard-query-role Description: Nh·∫≠p Execution role for Lambda function Nh·∫•n \u0026ldquo;Create role\u0026rdquo; Th√™m inline policy:\nSau khi t·∫°o, b·∫°n s·∫Ω ·ªü trang chi ti·∫øt role Nh·∫•n v√†o tab \u0026ldquo;Permissions\u0026rdquo; Nh·∫•n \u0026ldquo;Add permissions\u0026rdquo; ‚Üí \u0026ldquo;Create inline policy\u0026rdquo; T·∫°o inline policy:\nNh·∫•n v√†o tab \u0026ldquo;JSON\u0026rdquo; D√°n policy sau: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;AthenaActions\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;athena:StartQueryExecution\u0026#34;, \u0026#34;athena:GetQueryExecution\u0026#34;, \u0026#34;athena:GetQueryResults\u0026#34;, \u0026#34;athena:StopQueryExecution\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Sid\u0026#34;: \u0026#34;GlueCatalogRead\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;glue:GetDatabase\u0026#34;, \u0026#34;glue:GetDatabases\u0026#34;, \u0026#34;glue:GetTable\u0026#34;, \u0026#34;glue:GetTables\u0026#34;, \u0026#34;glue:GetPartitions\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; }, { \u0026#34;Sid\u0026#34;: \u0026#34;S3SourceAndResultAccess\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetBucketLocation\u0026#34;, \u0026#34;s3:GetObject\u0026#34;, \u0026#34;s3:ListBucket\u0026#34;, \u0026#34;s3:PutObject\u0026#34;, \u0026#34;s3:AbortMultipartUpload\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::vel-athena-results\u0026#34;, \u0026#34;arn:aws:s3:::vel-athena-results/*\u0026#34;, \u0026#34;arn:aws:s3:::vel-processed-cloudtrail-logs\u0026#34;, \u0026#34;arn:aws:s3:::vel-processed-cloudtrail-logs/*\u0026#34;, \u0026#34;arn:aws:s3:::vel-processed-guardduty\u0026#34;, \u0026#34;arn:aws:s3:::vel-processed-guardduty/*\u0026#34;, \u0026#34;arn:aws:s3:::cloudwatch-formatted\u0026#34;, \u0026#34;arn:aws:s3:::cloudwatch-formatted/*\u0026#34; ] } ] } Nh·∫•n \u0026ldquo;Next\u0026rdquo;\nT√™n Policy:\nPolicy name: Nh·∫≠p lambda-query-policy Nh·∫•n \u0026ldquo;Create policy\u0026rdquo; X√°c minh t·∫°o role:\nB·∫°n s·∫Ω th·∫•y role v·ªõi c·∫£ managed v√† inline policies ƒë∆∞·ª£c ƒë√≠nh k√®m "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.1-setup-s3/","title":"C√†i ƒë·∫∑t S3 Bucket cho Dashboard","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t m·ªôt S3 ƒë·ªÉ ch·ª©a c√°c file web v√† folder. Quan tr·ªçng: Thay th·∫ø ACCOUNT_ID b·∫±ng AWS Account ID c·ªßa b·∫°n v√† REGION b·∫±ng region m·ª•c ti√™u (v√≠ d·ª•: us-east-1) trong t·∫•t c·∫£ t√™n bucket.\nT√™n Bucket static-dashboard-bucket-ACCOUNT_ID-REGION - L∆∞u tr·ªØ c√°c file web v√† folder ƒë√£ build\nH∆∞·ªõng d·∫´n t·∫°o Bucket M·ªü Amazon S3 Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/s3/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí S3 Nh·∫•n v√†o \u0026ldquo;Create bucket\u0026rdquo;\nC√†i ƒë·∫∑t t·∫°o Bucket:\nGi·ªØ c√°c c√†i ƒë·∫∑t nh∆∞ m·∫∑c ƒë·ªãnh: Bucket name: Nh·∫≠p static-dashboard-bucket-ACCOUNT_ID-REGION V√≠ d·ª•: static-dashboard-bucket-123456789012-us-east-1 Ownership: ACLs disabled Block Public Access: Block all public access Bucket versioning: Disable Tags (T√πy ch·ªçn): Th√™m n·∫øu b·∫°n mu·ªën Encryption: SSE-S3 Bucket key: Enable Nh·∫•n Create bucket X√°c minh t·∫°o bucket:\nB·∫°n s·∫Ω th·∫•y m·ªôt th√¥ng b√°o th√†nh c√¥ng Bucket s·∫Ω xu·∫•t hi·ªán trong danh s√°ch S3 bucket c·ªßa b·∫°n T·∫£i l√™n files v√† folder:\nTruy c·∫≠p Github ƒë·ªÉ l·∫•y n·ªôi dung web v√† t·∫£i l√™n S3 "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/10-cleanup/10.1-manual-cleanup/","title":"D·ªçn d·∫πp th·ªß c√¥ng","tags":[],"description":"","content":"Clean up (Thi·∫øt l·∫≠p c∆° s·ªü h·∫° t·∫ßng th·ªß c√¥ng) Giai ƒëo·∫°n 1: D·ªçn d·∫πp Automation v√† Monitoring M·ª•c ti√™u ·ªü ƒë√¢y l√† d·ª´ng t·∫•t c·∫£ c√°c ti·∫øn tr√¨nh ƒëang ho·∫°t ƒë·ªông v√† x√≥a c√°c t√†i nguy√™n monitoring v√† automation c·ªët l√µi (EventBridge, Step Functions, SNS, GuardDuty, Flow Logs, CloudTrail).\n1. X√≥a Incident Response Automation 1.1 X√≥a EventBridge Rule\nV√†o EventBridge Console ‚Üí Rules. Ch·ªçn rule: IncidentResponseAlert. Nh·∫•n \u0026ldquo;Delete\u0026rdquo;. 1.2 X√≥a Step Functions State Machine\nV√†o Step Functions Console ‚Üí State Machines. Ch·ªçn State Machine: IncidentResponseStepFunctions. Nh·∫•n \u0026ldquo;Delete\u0026rdquo;. 1.3 X√≥a SNS Topic v√† Subscription\nV√†o SNS Console ‚Üí Topics ‚Üí IncidentResponseAlerts. ƒê·∫ßu ti√™n, x√≥a subscription li√™n k·∫øt v·ªõi ir-alert-dispatch. Sau ƒë√≥, x√≥a ch√≠nh topic b·∫±ng c√°ch nh·∫•n \u0026ldquo;Delete topic\u0026rdquo;. 1.4 X√≥a GuardDuty Detector\nV√†o GuardDuty Console ‚Üí Settings ‚Üí General. Nh·∫•n \u0026ldquo;Suspend\u0026rdquo; ƒë·ªÉ d·ª´ng x·ª≠ l√Ω, sau ƒë√≥ nh·∫•n \u0026ldquo;Disable GuardDuty\u0026rdquo; (ho·∫∑c \u0026ldquo;Delete detector\u0026rdquo;). 1.5 V√¥ hi·ªáu h√≥a VPC Flow Logs\nV√†o VPC Console ‚Üí VPC Flow Logs. Ch·ªçn flow log ƒë√£ t·∫°o (li√™n k·∫øt v·ªõi YOUR_VPC_ID). Nh·∫•n \u0026ldquo;Delete flow log\u0026rdquo;. 1.6 X√≥a CloudTrail Trail\nV√†o CloudTrail Console ‚Üí Trails. Ch·ªçn trail: incident-responses-cloudtrail-ACCOUNT_ID-REGION. Nh·∫•n \u0026ldquo;Delete\u0026rdquo;. Giai ƒëo·∫°n 2: D·ªçn d·∫πp Lambda v√† Compute 2. X√≥a t·∫•t c·∫£ Lambda Functions (9 Functions) V√†o Lambda Console v√† x√≥a c√°c functions sau:\nincident-response-cloudtrail-etl incident-response-guardduty-etl cloudwatch-etl-lambda cloudwatch-eni-etl-lambda cloudwatch-export-lambda ir-parse-findings-lambda ir-isolate-ec2-lambda ir-quarantine-iam-lambda ir-alert-dispatch 3. X√≥a Isolation Security Group V√†o EC2 Console ‚Üí Security Groups. T√¨m v√† ch·ªçn Security Group: IR-Isolation-SG (s·ª≠ d·ª•ng ID sg-XXXXXXX). Nh·∫•n \u0026ldquo;Delete security group\u0026rdquo;. 4. X√≥a CloudWatch Log Groups V√†o CloudWatch Console ‚Üí Log Groups v√† x√≥a:\nCentralized log group: /aws/incident-response/centralized-logs. B·∫•t k·ª≥ Lambda log groups n√†o li√™n quan ƒë·∫øn 9 functions ƒë√£ x√≥a (v√≠ d·ª•: /aws/lambda/ir-parse-findings-lambda). Giai ƒëo·∫°n 3: D·ªçn d·∫πp Processing v√† Data Lake 5. X√≥a Kinesis Data Firehose Streams V√†o Kinesis Console ‚Üí Delivery Streams v√† x√≥a:\ncloudtrail-firehose-stream vpc-dns-firehose-stream vpc-flow-firehose-stream 6. X√≥a AWS Glue Tables v√† Database 6.1 X√≥a Glue Tables\nV√†o Glue Console ‚Üí Tables. Ch·ªçn v√† x√≥a: security_logs.processed_cloudtrail, security_logs.processed_guardduty, security_logs.vpc_logs, v√† security_logs.eni_flow_logs. 6.2 X√≥a Glue Database\nV√†o Glue Console ‚Üí Databases. Ch·ªçn database: security_logs v√† nh·∫•n \u0026ldquo;Delete\u0026rdquo;. 7. X√≥a IAM Roles v√† Policies 7.1 X√≥a IAM Policies\nV√†o IAM Console ‚Üí Policies. X√≥a custom managed policy: IrQuarantineIAMPolicy. L∆∞u √Ω: Inline policies ƒë∆∞·ª£c t·∫°o trong qu√° tr√¨nh c√†i ƒë·∫∑t s·∫Ω t·ª± ƒë·ªông b·ªã x√≥a khi role t∆∞∆°ng ·ª©ng b·ªã x√≥a. 7.2 X√≥a IAM Roles\nV√†o IAM Console ‚Üí Roles. X√≥a 17 roles sau: Lambda Execution Roles: CloudTrailETLLambdaServiceRole, GuardDutyETLLambdaServiceRole, CloudWatchETLLambdaServiceRole, CloudWatchENIETLLambdaServiceRole, CloudWatchExportLambdaServiceRole, ParseFindingsLambdaServiceRole, IsolateEC2LambdaServiceRole, QuarantineIAMLambdaServiceRole, AlertDispatchLambdaServiceRole. Service Roles: CloudTrailFirehoseRole, CloudWatchFirehoseRole, StepFunctionsRole, IncidentResponseStepFunctionsEventRole, FlowLogsIAMRole, GlueCloudWatchRole. Giai ƒëo·∫°n 4: D·ªçn d·∫πp S3 Bucket (X√≥a d·ªØ li·ªáu) 8. L√†m tr·ªëng v√† X√≥a S3 Buckets ƒê√¢y l√† b∆∞·ªõc cu·ªëi c√πng ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c kho·∫£n ph√≠ l∆∞u tr·ªØ ƒë∆∞·ª£c d·ª´ng l·∫°i.\nBucket Name M·ª•c ƒë√≠ch incident-response-log-list-bucket-ACCOUNT_ID-REGION Ngu·ªìn Log Ch√≠nh (CloudTrail/GuardDuty/Exported CW) processed-cloudtrail-logs-ACCOUNT_ID-REGION Firehose Destination cho CloudTrail logs processed-cloudwatch-logs-ACCOUNT_ID-REGION Firehose Destination cho VPC DNS/Flow logs processed-guardduty-findings-ACCOUNT_ID-REGION ETL Destination cho GuardDuty logs athena-query-results-ACCOUNT_ID-REGION L∆∞u tr·ªØ k·∫øt qu·∫£ truy v·∫•n Athena V√†o S3 Console. ƒê·ªëi v·ªõi m·ªói bucket trong 5 buckets: Nh·∫•n v√†o t√™n bucket. V√†o tab \u0026ldquo;Objects\u0026rdquo;. Nh·∫•n \u0026ldquo;Empty\u0026rdquo; ƒë·ªÉ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu. B·∫°n ph·∫£i x√°c nh·∫≠n vi·ªác x√≥a vƒ©nh vi·ªÖn b·∫±ng c√°ch g√µ permanently delete. Quay l·∫°i danh s√°ch S3 bucket, ch·ªçn bucket, v√† nh·∫•n \u0026ldquo;Delete\u0026rdquo;. "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.1-cloudtrail-etl/","title":"M√£ CloudTrail ETL","tags":[],"description":"","content":" import json import boto3 import gzip import re import os from datetime import datetime, timezone s3 = boto3.client(\u0026#34;s3\u0026#34;) firehose= boto3.client(\u0026#34;firehose\u0026#34;) # -------------------------------------------------- # C·∫§U H√åNH (CONFIG) # -------------------------------------------------- SOURCE_PREFIX = \u0026#34;exportedlogs/vpc-dns-logs/\u0026#34; FIREHOSE_STREAM_NAME = os.environ.get(\u0026#34;FIREHOSE_STREAM_NAME\u0026#34;) VPC_RE = re.compile(r\u0026#34;/(vpc-[0-9A-Za-z\\-]+)\u0026#34;) ISO_TS_RE = re.compile(r\u0026#34;^\\d{4}-\\d{2}-\\d{2}T\u0026#34;) def read_gz(bucket, key): obj = s3.get_object(Bucket=bucket, Key=key) with gzip.GzipFile(fileobj=obj[\u0026#34;Body\u0026#34;]) as f: return f.read().decode(\u0026#34;utf-8\u0026#34;, errors=\u0026#34;replace\u0026#34;) def flatten_once(d): out = {} for k, v in (d or {}).items(): if isinstance(v, dict): for k2, v2 in v.items(): out[f\u0026#34;{k}_{k2}\u0026#34;] = v2 else: out[k] = v return out def safe_int(x): try: return int(x) except: return None def parse_dns_line(line): raw = line.strip() if not raw: return None json_part = raw prefix_ts = None if ISO_TS_RE.match(raw): try: prefix_ts, rest = raw.split(\u0026#34; \u0026#34;, 1) json_part = rest except: pass if not json_part.startswith(\u0026#34;{\u0026#34;): idx = json_part.find(\u0026#34;{\u0026#34;) if idx != -1: json_part = json_part[idx:] try: obj = json.loads(json_part) except: return None flat = flatten_once(obj) if prefix_ts: flat[\u0026#34;_prefix_ts\u0026#34;] = prefix_ts return flat def lambda_handler(event, context): print(f\u0026#34;Received S3 Event. Records: {len(event.get(\u0026#39;Records\u0026#39;, []))}\u0026#34;) firehose_records = [] for record in event.get(\u0026#34;Records\u0026#34;, []): if \u0026#34;s3\u0026#34; not in record: continue bucket = record[\u0026#34;s3\u0026#34;][\u0026#34;bucket\u0026#34;][\u0026#34;name\u0026#34;] key = record[\u0026#34;s3\u0026#34;][\u0026#34;object\u0026#34;][\u0026#34;key\u0026#34;] if not key.startswith(SOURCE_PREFIX) or not key.endswith(\u0026#34;.gz\u0026#34;): print(f\u0026#34;Skipping file: {key}\u0026#34;) continue print(f\u0026#34;Processing S3 file: {key}\u0026#34;) # Tr√≠ch xu·∫•t VPC ID t·ª´ ƒë∆∞·ªùng d·∫´n file (Extract VPC ID from file path) vpc_id_match = VPC_RE.search(key) vpc_id = vpc_id_match.group(1) if vpc_id_match else \u0026#34;unknown\u0026#34; # ƒê·ªçc v√† x·ª≠ l√Ω n·ªôi dung file (Read and process file content) content = read_gz(bucket, key) if not content: continue for line in content.splitlines(): r = parse_dns_line(line) if not r: continue # T·∫°o flattened JSON record (Create flattened JSON record) out = { \u0026#34;version\u0026#34;: r.get(\u0026#34;version\u0026#34;), \u0026#34;account_id\u0026#34;: r.get(\u0026#34;account_id\u0026#34;), \u0026#34;region\u0026#34;: r.get(\u0026#34;region\u0026#34;), \u0026#34;vpc_id\u0026#34;: r.get(\u0026#34;vpc_id\u0026#34;, vpc_id), \u0026#34;query_timestamp\u0026#34;: r.get(\u0026#34;query_timestamp\u0026#34;), \u0026#34;query_name\u0026#34;: r.get(\u0026#34;query_name\u0026#34;), \u0026#34;query_type\u0026#34;: r.get(\u0026#34;query_type\u0026#34;), \u0026#34;query_class\u0026#34;: r.get(\u0026#34;query_class\u0026#34;), \u0026#34;rcode\u0026#34;: r.get(\u0026#34;rcode\u0026#34;), \u0026#34;answers\u0026#34;: json.dumps(r.get(\u0026#34;answers\u0026#34;), ensure_ascii=False), \u0026#34;srcaddr\u0026#34;: r.get(\u0026#34;srcaddr\u0026#34;), \u0026#34;srcport\u0026#34;: safe_int(r.get(\u0026#34;srcport\u0026#34;)), \u0026#34;transport\u0026#34;: r.get(\u0026#34;transport\u0026#34;), \u0026#34;srcids_instance\u0026#34;: r.get(\u0026#34;srcids_instance\u0026#34;), \u0026#34;timestamp\u0026#34;: (r.get(\u0026#34;query_timestamp\u0026#34;) or r.get(\u0026#34;timestamp\u0026#34;) or r.get(\u0026#34;_prefix_ts\u0026#34;)) } # Th√™m d√≤ng m·ªõi cho ƒë·ªãnh d·∫°ng JSONL (Add newline for JSONL format) json_row = json.dumps(out, ensure_ascii=False) + \u0026#34;\\n\u0026#34; firehose_records.append({\u0026#39;Data\u0026#39;: json_row}) # G·ª≠i ƒë·∫øn Firehose theo batch 500 (Send to Firehose in batches of 500) if firehose_records: total_records = len(firehose_records) print(f\u0026#34;Sending {total_records} records to Firehose...\u0026#34;) batch_size = 500 for i in range(0, total_records, batch_size): batch = firehose_records[i:i + batch_size] try: response = firehose.put_record_batch( DeliveryStreamName=FIREHOSE_STREAM_NAME, Records=batch ) if response[\u0026#39;FailedPutCount\u0026#39;] \u0026gt; 0: print(f\u0026#34;Warning: {response[\u0026#39;FailedPutCount\u0026#39;]} records failed\u0026#34;) except Exception as e: print(f\u0026#34;Firehose error: {e}\u0026#34;) return {\u0026#34;status\u0026#34;: \u0026#34;ok\u0026#34;, \u0026#34;total_records\u0026#34;: len(firehose_records)} "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/5-processing-setup/5.1-create-kinesis-data-firehose/","title":"T·∫°o Kinesis Data Firehose","tags":[],"description":"","content":"T·∫°o Kinesis Data Firehose Delivery Streams T·∫°o cloudtrail-firehose-stream M·ªü Kinesis Console ‚Üí Delivery streams ‚Üí Create delivery stream\nC·∫•u h√¨nh:\nSource: Direct PUT Destination: Amazon S3 Stream name: cloudtrail-firehose-stream S3 bucket: processed-cloudtrail-logs-ACCOUNT_ID-REGION Prefix: processed-cloudtrail/date=!{timestamp:yyyy-MM-dd}/ Error prefix: processed-cloudtrail/errors/date=!{timestamp:yyyy-MM-dd}/error-type=!{firehose:error-output-type}/ Buffer size: 10 MB Buffer interval: 300 seconds Compression: GZIP IAM role: CloudTrailFirehoseRole Create delivery stream\nT·∫°o vpc-dns-firehose-stream Stream name: vpc-dns-firehose-stream S3 bucket: processed-cloudwatch-logs-ACCOUNT_ID-REGION Prefix: vpc-logs/date=!{timestamp:yyyy-MM-dd}/ Error prefix: vpc-logs/errors/date=!{timestamp:yyyy-MM-dd}/error-type=!{firehose:error-output-type}/ IAM role: CloudWatchFirehoseRole (C√†i ƒë·∫∑t buffer/compression gi·ªëng nh∆∞ tr√™n) T·∫°o vpc-flow-firehose-stream Stream name: vpc-flow-firehose-stream S3 bucket: processed-cloudwatch-logs-ACCOUNT_ID-REGION Prefix: eni-flow-logs/date=!{timestamp:yyyy-MM-dd}/ Error prefix: eni-flow-logs/errors/date=!{timestamp:yyyy-MM-dd}/error-type=!{firehose:error-output-type}/ IAM role: CloudWatchFirehoseRole (C√†i ƒë·∫∑t buffer/compression gi·ªëng nh∆∞ tr√™n) "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.3-create-iam-roles-and-policies/3.3.1-create-lambda-excecution-roles/","title":"T·∫°o Lambda Execution Roles","tags":[],"description":"","content":"T·∫°o CloudTrailETLLambdaServiceRole M·ªü IAM Console:\nƒêi·ªÅu h∆∞·ªõng ƒë·∫øn https://console.aws.amazon.com/iam/ Ho·∫∑c: AWS Management Console ‚Üí T√¨m ki·∫øm \u0026ldquo;IAM\u0026rdquo; ‚Üí Nh·∫•n \u0026ldquo;IAM\u0026rdquo; ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn Roles:\n·ªû thanh b√™n tr√°i, nh·∫•n \u0026ldquo;Roles\u0026rdquo; Nh·∫•n \u0026ldquo;Create role\u0026rdquo;\nCh·ªçn trusted entity:\nTrusted entity type: Ch·ªçn \u0026ldquo;AWS service\u0026rdquo; Use case: Ch·ªçn \u0026ldquo;Lambda\u0026rdquo; Nh·∫•n \u0026ldquo;Next\u0026rdquo; Th√™m permissions:\nTrong h·ªôp t√¨m ki·∫øm, nh·∫≠p AWSLambdaBasicExecutionRole ƒê√°nh d·∫•u v√†o √¥ b√™n c·∫°nh \u0026ldquo;AWSLambdaBasicExecutionRole\u0026rdquo; Nh·∫•n \u0026ldquo;Next\u0026rdquo; ƒê·∫∑t t√™n, xem l·∫°i, v√† t·∫°o:\nRole name: Nh·∫≠p CloudTrailETLLambdaServiceRole Description: Nh·∫≠p Execution role for CloudTrail ETL Lambda function Nh·∫•n \u0026ldquo;Create role\u0026rdquo; Th√™m inline policy:\nSau khi t·∫°o, b·∫°n s·∫Ω ·ªü trang chi ti·∫øt role Nh·∫•n v√†o tab \u0026ldquo;Permissions\u0026rdquo; Nh·∫•n \u0026ldquo;Add permissions\u0026rdquo; ‚Üí \u0026ldquo;Create inline policy\u0026rdquo; T·∫°o inline policy:\nNh·∫•n v√†o tab \u0026ldquo;JSON\u0026rdquo; D√°n policy sau (thay th·∫ø ACCOUNT_ID v√† REGION): { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;firehose:PutRecord\u0026#34;, \u0026#34;firehose:PutRecordBatch\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:firehose:REGION:ACCOUNT_ID:deliverystream/cloudtrail-firehose-stream\u0026#34; } ] } Nh·∫•n \u0026ldquo;Next\u0026rdquo;\nT√™n Policy:\nPolicy name: Nh·∫≠p CloudTrailETLPolicy Nh·∫•n \u0026ldquo;Create policy\u0026rdquo; X√°c minh t·∫°o role:\nB·∫°n s·∫Ω th·∫•y role v·ªõi c·∫£ managed v√† inline policies ƒë∆∞·ª£c ƒë√≠nh k√®m T·∫°o c√°c Lambda Roles c√≤n l·∫°i L√†m theo quy tr√¨nh t∆∞∆°ng t·ª± cho m·ªói role d∆∞·ªõi ƒë√¢y (c√°c b∆∞·ªõc 3-11):\nGuardDutyETLLambdaServiceRole\nRole name: GuardDutyETLLambdaServiceRole Description: Execution role for GuardDuty ETL Lambda function Managed policy: AWSLambdaBasicExecutionRole Inline policy name: GuardDutyETLPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetObject\u0026#34;, \u0026#34;s3:PutObject\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34;, \u0026#34;arn:aws:s3:::processed-guardduty-findings-ACCOUNT_ID-REGION/*\u0026#34; ] }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;kms:Decrypt\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:kms:REGION:ACCOUNT_ID:key/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;glue:CreatePartition\u0026#34;, \u0026#34;glue:GetPartition\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:glue:REGION:ACCOUNT_ID:catalog\u0026#34;, \u0026#34;arn:aws:glue:REGION:ACCOUNT_ID:database/security_logs\u0026#34;, \u0026#34;arn:aws:glue:REGION:ACCOUNT_ID:table/security_logs/processed_guardduty\u0026#34; ] } ] } CloudWatchETLLambdaServiceRole\nRole name: CloudWatchETLLambdaServiceRole Description: Execution role for VPC DNS logs ETL Lambda Managed policy: AWSLambdaBasicExecutionRole Inline policy name: CloudWatchETLPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;firehose:PutRecord\u0026#34;, \u0026#34;firehose:PutRecordBatch\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:firehose:REGION:ACCOUNT_ID:deliverystream/vpc-dns-firehose-stream\u0026#34; } ] } CloudWatchENIETLLambdaServiceRole\nRole name: CloudWatchENIETLLambdaServiceRole Description: Execution role for VPC Flow logs ETL Lambda Managed policy: AWSLambdaBasicExecutionRole Inline policy name: CloudWatchENIETLPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;firehose:PutRecord\u0026#34;, \u0026#34;firehose:PutRecordBatch\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:firehose:REGION:ACCOUNT_ID:deliverystream/vpc-flow-firehose-stream\u0026#34; } ] } CloudWatchExportLambdaServiceRole\nRole name: CloudWatchExportLambdaServiceRole Description: Execution role for CloudWatch log export Lambda Managed policy: AWSLambdaBasicExecutionRole Inline policy name: CloudWatchExportPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;logs:CreateExportTask\u0026#34;, \u0026#34;logs:DescribeExportTasks\u0026#34;, \u0026#34;s3:PutObject\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:logs:REGION:ACCOUNT_ID:log-group:*\u0026#34;, \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34; ] } ] } ParseFindingsLambdaServiceRole\nRole name: ParseFindingsLambdaServiceRole Description: Execution role for parsing GuardDuty findings Managed policy: AWSLambdaBasicExecutionRole Kh√¥ng c·∫ßn inline policy IsolateEC2LambdaServiceRole\nRole name: IsolateEC2LambdaServiceRole Description: Execution role for isolating compromised EC2 instances Managed policy: AWSLambdaBasicExecutionRole Inline policy name: IsolateEC2Policy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ec2:DescribeInstances\u0026#34;, \u0026#34;ec2:ModifyInstanceAttribute\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } QuarantineIAMLambdaServiceRole\nRole name: QuarantineIAMLambdaServiceRole Description: Execution role for quarantining compromised IAM users Managed policy: AWSLambdaBasicExecutionRole Inline policy name: QuarantineIAMPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;iam:AttachUserPolicy\u0026#34;, \u0026#34;iam:ListAttachedUserPolicies\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:iam::ACCOUNT_ID:user/*\u0026#34;, \u0026#34;arn:aws:iam::ACCOUNT_ID:policy/IrQuarantineIAMPolicy\u0026#34; ] } ] } AlertDispatchLambdaServiceRole\nRole name: AlertDispatchLambdaServiceRole Description: Execution role for dispatching alerts via SNS/SES/Slack Managed policy: AWSLambdaBasicExecutionRole Inline policy name: AlertDispatchPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;sns:Publish\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:sns:REGION:ACCOUNT_ID:IncidentResponseAlerts\u0026#34; }, { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;ses:SendEmail\u0026#34;, \u0026#34;ses:SendRawEmail\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.1-set-up-s3-buckets/","title":"Thi·∫øt l·∫≠p S3 buckets","tags":[],"description":"","content":"Trong ph·∫ßn n√†y, b·∫°n s·∫Ω t·∫°o 5 S3 buckets ph·ª•c v·ª• l√†m n·ªÅn t·∫£ng cho h·ªá th·ªëng Ph·∫£n h·ªìi S·ª± c·ªë T·ª± ƒë·ªông (Auto Incident Response system).\nQuan tr·ªçng: Thay th·∫ø ACCOUNT_ID b·∫±ng AWS Account ID c·ªßa b·∫°n v√† REGION b·∫±ng region m·ª•c ti√™u c·ªßa b·∫°n (v√≠ d·ª•: us-east-1) trong t·∫•t c·∫£ c√°c t√™n bucket.\nT√™n Bucket incident-response-log-list-bucket-ACCOUNT_ID-REGION - Bucket thu th·∫≠p log ch√≠nh processed-cloudtrail-logs-ACCOUNT_ID-REGION - L∆∞u tr·ªØ CloudTrail logs ƒë√£ x·ª≠ l√Ω athena-query-results-ACCOUNT_ID-REGION - L∆∞u tr·ªØ k·∫øt qu·∫£ truy v·∫•n Athena processed-cloudwatch-logs-ACCOUNT_ID-REGION - L∆∞u tr·ªØ CloudWatch logs ƒë√£ x·ª≠ l√Ω processed-guardduty-findings-ACCOUNT_ID-REGION - L∆∞u tr·ªØ GuardDuty findings ƒë√£ x·ª≠ l√Ω H∆∞·ªõng d·∫´n t·∫°o Bucket M·ªü Amazon S3 Console Truy c·∫≠p https://console.aws.amazon.com/s3/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí S3 Nh·∫•n v√†o \u0026ldquo;Create bucket\u0026rdquo; C·∫•u h√¨nh chung: Bucket name: Nh·∫≠p incident-response-log-list-bucket-ACCOUNT_ID-REGION V√≠ d·ª•: incident-response-log-list-bucket-123456789012-us-east-1 AWS Region: Ch·ªçn region m·ª•c ti√™u c·ªßa b·∫°n (v√≠ d·ª•: US East (N. Virginia) us-east-1) Object Ownership:\nGi·ªØ m·∫∑c ƒë·ªãnh: ACLs disabled (recommended) C√†i ƒë·∫∑t Block Public Access cho bucket n√†y:\nCh·ªçn \u0026ldquo;Block all public access\u0026rdquo; ƒê·∫£m b·∫£o t·∫•t c·∫£ 4 t√πy ch·ªçn ph·ª• ƒë·ªÅu ƒë∆∞·ª£c ch·ªçn: ‚úì Block public access to buckets and objects granted through new access control lists (ACLs) ‚úì Block public access to buckets and objects granted through any access control lists (ACLs) ‚úì Block public access to buckets and objects granted through new public bucket or access point policies ‚úì Block public and cross-account access to buckets and objects through any public bucket or access point policies Bucket Versioning:\nCh·ªçn \u0026ldquo;Enable\u0026rdquo; Tags (t√πy ch·ªçn):\nTh√™m tags n·∫øu mu·ªën V√≠ d·ª•: Key=Purpose, Value=IncidentResponse M√£ h√≥a m·∫∑c ƒë·ªãnh (Default encryption):\nEncryption type: Ch·ªçn \u0026ldquo;Server-side encryption with Amazon S3 managed keys (SSE-S3)\u0026rdquo; Bucket Key: Gi·ªØ m·∫∑c ƒë·ªãnh (Enabled) C√†i ƒë·∫∑t n√¢ng cao (Advanced settings):\nGi·ªØ nguy√™n t·∫•t c·∫£ m·∫∑c ƒë·ªãnh Nh·∫•n \u0026ldquo;Create bucket\u0026rdquo;\nX√°c minh t·∫°o bucket:\nB·∫°n s·∫Ω th·∫•y th√¥ng b√°o th√†nh c√¥ng Bucket s·∫Ω xu·∫•t hi·ªán trong danh s√°ch S3 buckets c·ªßa b·∫°n L·∫∑p l·∫°i c√°c b∆∞·ªõc 2-10 cho 4 buckets c√≤n l·∫°i:\nprocessed-cloudtrail-logs-ACCOUNT_ID-REGION athena-query-results-ACCOUNT_ID-REGION processed-cloudwatch-logs-ACCOUNT_ID-REGION processed-guardduty-findings-ACCOUNT_ID-REGION X√°c minh t·∫•t c·∫£ 5 buckets ƒë√£ ƒë∆∞·ª£c t·∫°o:\nƒêi·ªÅu h∆∞·ªõng ƒë·∫øn S3 Console B·∫°n s·∫Ω th·∫•y t·∫•t c·∫£ 5 buckets ƒë∆∞·ª£c li·ªát k√™ "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/1-workshop-overview/","title":"T·ªïng quan","tags":[],"description":"","content":"C√°c th√†nh ph·∫ßn h·ªá th·ªëng Ph·∫£n h·ªìi s·ª± c·ªë v√† ƒêi·ªÅu tra s·ªë t·ª± ƒë·ªông (Auto Incident Response and Forensics) l√† m·ªôt ki·∫øn tr√∫c s·ª≠ d·ª•ng c√°c d·ªãch v·ª• t·ª± ƒë·ªông h√≥a ƒë·ªÉ thu th·∫≠p, x·ª≠ l√Ω v√† t·ª± ƒë·ªông ph·∫£n h·ªìi c√°c ph√°t hi·ªán b·∫£o m·∫≠t, gi·∫£m thi·ªÉu th·ªùi gian c·∫ßn thi·∫øt cho s·ª± can thi·ªáp c·ªßa con ng∆∞·ªùi v√† h·ªó tr·ª£ nh√¢n vi√™n b·∫£o m·∫≠t trong vi·ªác tr·ª±c quan h√≥a v√† ph√¢n t√≠ch log. H·ªá th·ªëng n√†y ƒë∆∞·ª£c x√¢y d·ª±ng d·ª±a tr√™n AWS Security Services (CloudTrail, GuardDuty, VPC Flow Logs, CloudWatch) ƒë∆∞a d·ªØ li·ªáu v√†o m·ªôt Data Lake t·∫≠p trung (S3/Glue/Athena) ƒë·ªÉ ph√¢n t√≠ch. T·ª± ƒë·ªông h√≥a c·ªët l√µi ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn b·ªüi AWS EventBridge rules k√≠ch ho·∫°t AWS Step Functions workflows, sau ƒë√≥ th·ª±c thi AWS Lambda functions ƒë·ªÉ th·ª±c hi·ªán c√°c h√†nh ƒë·ªông c√°ch ly v√† c·∫£nh b√°o. ·∫¢nh ki·∫øn tr√∫c c·ªßa Workshop\nT·ªïng quan v·ªÅ Workshop Trong workshop n√†y, b·∫°n s·∫Ω tri·ªÉn khai m·ªôt h·ªá th·ªëng ƒëa giai ƒëo·∫°n ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c t·ª± ƒë·ªông h√≥a b·∫£o m·∫≠t t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi. Bao g·ªìm:\nThi·∫øt l·∫≠p n·ªÅn t·∫£ng (Foundation Setup): T·∫°o c√°c S3 buckets v√† IAM roles chuy√™n d·ª•ng ƒë·ªÉ h·ªó tr·ª£ t·∫•t c·∫£ c√°c d·ªãch v·ª•. Thi·∫øt l·∫≠p gi√°m s√°t (Monitoring Setup): K√≠ch ho·∫°t v√† c·∫•u h√¨nh c√°c log b·∫£o m·∫≠t ch√≠nh (CloudTrail, GuardDuty, VPC Flow Logs) ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu ƒë·∫øn ƒëi·ªÉm thu th·∫≠p log trung t√¢m. Thi·∫øt l·∫≠p x·ª≠ l√Ω (Processing Setup): Tri·ªÉn khai Kinesis Firehose, Lambda ETLs, v√† Glue/Athena tables ƒë·ªÉ chuy·ªÉn ƒë·ªïi log th√¥ th√†nh m·ªôt security data lake d·ªÖ d√†ng truy v·∫•n. Thi·∫øt l·∫≠p t·ª± ƒë·ªông h√≥a (Automation Setup): T·∫°o Isolation Security Group, SNS Topic, Incident Response Lambda Functions, v√† Step Functions State Machine th·ª±c thi c√°c h√†nh ƒë·ªông c√°ch ly t·ª± ƒë·ªông khi GuardDuty ph√°t hi·ªán c√°c v·∫•n ƒë·ªÅ. Thi·∫øt l·∫≠p Dashboard (Dashboard Setup): L∆∞u tr·ªØ m·ªôt giao di·ªán web tƒ©nh d·ª±a tr√™n S3 an to√†n ƒë∆∞·ª£c tƒÉng t·ªëc b·ªüi CloudFront v√† b·∫£o v·ªá b·ªüi Cognito ƒë·ªÉ cung c·∫•p cho c√°c nh√† ph√¢n t√≠ch kh·∫£ nƒÉng tr·ª±c quan h√≥a th·ªùi gian th·ª±c c·ªßa d·ªØ li·ªáu ƒëi·ªÅu tra (forensic data) v√† kh·∫£ nƒÉng truy v·∫•n tr·ª±c ti·∫øp qua API Gateway. "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.2-setup-lambda/","title":"C√†i ƒë·∫∑t IAM Roles v√† Policies","tags":[],"description":"","content":"Trong ph·∫ßn n√†y, b·∫°n s·∫Ω t·∫°o IAM role v√† Policy cho Lambda. Sau ƒë√≥ b·∫°n s·∫Ω t·∫°o Lambda Function ƒë·ªÉ th·ª±c thi truy v·∫•n.\nN·ªôi dung T·∫°o Lambda Execution Roles v√† Policy T·∫°o Lambda Function "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.2-setup-lambda/7.2.2-create-lambda-function/","title":"C√†i ƒë·∫∑t Lambda","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t m·ªôt Lambda s·ª≠ d·ª•ng Python ƒë·ªÉ th·ª±c thi truy v·∫•n d√πng d·ªãch v·ª• Athena.\nT·∫°o Lambda Function M·ªü Lambda Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/lambda/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí Lambda T·∫°o Function:\nNh·∫•n Create Function Trong m·ª•c c√†i ƒë·∫∑t t·∫°o m·ªõi, s·ª≠ d·ª•ng c√†i ƒë·∫∑t sau: Ch·ªçn Author from scratch Name: dashboard-query Runtime: Python 3.12 Architecture: x86_64 Change default execution role: Use an existing role Ch·ªçn dashboard-query-role Nh·∫•n Create Th√™m m√£ ngu·ªìn (code):\nTrong code editor copy v√† paste ƒëo·∫°n m√£ b√™n d∆∞·ªõi sau ƒë√≥ nh·∫•n Deploy: import boto3 import time import os import json athena = boto3.client(\u0026#39;athena\u0026#39;) RESOURCE_MAP = { \u0026#39;/logs/cloudtrail\u0026#39;: { \u0026#39;db\u0026#39;: \u0026#39;security_logs\u0026#39;, \u0026#39;table\u0026#39;: \u0026#39;processed_cloudtrail\u0026#39; }, \u0026#39;/logs/guardduty\u0026#39;: { \u0026#39;db\u0026#39;: \u0026#39;security_logs\u0026#39;, \u0026#39;table\u0026#39;: \u0026#39;processed_guardduty\u0026#39; }, \u0026#39;/logs/vpc\u0026#39;: { \u0026#39;db\u0026#39;: \u0026#39;security_logs\u0026#39;, \u0026#39;table\u0026#39;: \u0026#39;vpc_logs\u0026#39; }, \u0026#39;/logs/eni_logs\u0026#39;:{ \u0026#39;db\u0026#39;: \u0026#39;security_logs\u0026#39;, \u0026#39;table\u0026#39;: \u0026#39;eni_flow_logs\u0026#39; } } OUTPUT_BUCKET_NAME = os.environ.get(\u0026#34;ATHENA_OUTPUT_BUCKET\u0026#34;) REGION = os.environ.get(\u0026#34;REGION\u0026#34;) OUTPUT_BUCKET = f\u0026#39;s3://{OUTPUT_BUCKET_NAME}/\u0026#39; def lambda_handler(event, context): print(\u0026#34;Received event:\u0026#34;, json.dumps(event)) resource_path = event.get(\u0026#39;resource\u0026#39;) config = RESOURCE_MAP.get(resource_path) if not config: return api_response(400, {\u0026#39;error\u0026#39;: f\u0026#39;Unknown resource path: {resource_path}\u0026#39;}) database_name = config[\u0026#39;db\u0026#39;] table_name = config[\u0026#39;table\u0026#39;] query_params = event.get(\u0026#39;queryStringParameters\u0026#39;, {}) or {} if config[\u0026#39;table\u0026#39;] == \u0026#39;processed_cloudtrail\u0026#39;: query_string = f\u0026#34;\u0026#34;\u0026#34;SELECT * FROM {table_name} where \u0026#34;date\u0026#34; \u0026gt;= cast((current_date - interval \u0026#39;3\u0026#39; day) as varchar) order by eventtime desc\u0026#34;\u0026#34;\u0026#34; elif config[\u0026#39;table\u0026#39;] == \u0026#39;processed_guardduty\u0026#39;: query_string = f\u0026#34;\u0026#34;\u0026#34;SELECT * FROM {table_name} where \u0026#34;date\u0026#34; \u0026gt;= cast((current_date - interval \u0026#39;3\u0026#39; day) as varchar) order by date desc\u0026#34;\u0026#34;\u0026#34; elif config[\u0026#39;table\u0026#39;] == \u0026#39;vpc_logs\u0026#39;: query_string = f\u0026#34;\u0026#34;\u0026#34;SELECT * FROM {table_name} where \u0026#34;date\u0026#34; \u0026gt;= cast((current_date - interval \u0026#39;3\u0026#39; day) as varchar) order by timestamp desc\u0026#34;\u0026#34;\u0026#34; elif config[\u0026#39;table\u0026#39;] == \u0026#39;eni_flow_logs\u0026#39;: query_string = f\u0026#34;\u0026#34;\u0026#34;SELECT * FROM {table_name} where \u0026#34;date\u0026#34; \u0026gt;= cast((current_date - interval \u0026#39;3\u0026#39; day) as varchar) order by timestamp_str desc\u0026#34;\u0026#34;\u0026#34; print(f\u0026#34;Querying DB: {database_name}, Table: {table_name}, Output: {OUTPUT_BUCKET}\u0026#34;) try: response = athena.start_query_execution( QueryString=query_string, QueryExecutionContext={\u0026#39;Database\u0026#39;: database_name}, ResultConfiguration={\u0026#39;OutputLocation\u0026#39;: OUTPUT_BUCKET} ) query_execution_id = response[\u0026#39;QueryExecutionId\u0026#39;] status = \u0026#39;RUNNING\u0026#39; while status in [\u0026#39;RUNNING\u0026#39;, \u0026#39;QUEUED\u0026#39;]: response = athena.get_query_execution(QueryExecutionId=query_execution_id) status = response[\u0026#39;QueryExecution\u0026#39;][\u0026#39;Status\u0026#39;][\u0026#39;State\u0026#39;] if status in [\u0026#39;FAILED\u0026#39;, \u0026#39;CANCELLED\u0026#39;]: reason = response[\u0026#39;QueryExecution\u0026#39;][\u0026#39;Status\u0026#39;].get(\u0026#39;StateChangeReason\u0026#39;, \u0026#39;Unknown\u0026#39;) return api_response(500, {\u0026#39;error\u0026#39;: f\u0026#39;Query Failed: {reason}\u0026#39;}) time.sleep(1) results = athena.get_query_results(QueryExecutionId=query_execution_id) return api_response(200, results) except Exception as e: print(f\u0026#34;Error: {str(e)}\u0026#34;) return api_response(500, {\u0026#39;error\u0026#39;: str(e)}) def api_response(code, body): return { \u0026#34;statusCode\u0026#34;: code, \u0026#34;headers\u0026#34;: { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Access-Control-Allow-Origin\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Access-Control-Allow-Methods\u0026#34;: \u0026#34;GET, OPTIONS\u0026#34; }, \u0026#34;body\u0026#34;: json.dumps(body) } "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/10-cleanup/10.2-cdk-cleanup/","title":"D·ªçn d·∫πp CDK","tags":[],"description":"","content":"Clean up (CDK) H∆∞·ªõng d·∫´n n√†y ƒë·∫£m b·∫£o b·∫°n h·ªßy b·ªè (decommission) ch√≠nh x√°c t·∫•t c·∫£ c√°c t√†i nguy√™n ƒë∆∞·ª£c cung c·∫•p b·ªüi AWS CDK stack v√† d·ªçn d·∫πp d·ªØ li·ªáu ƒë∆∞·ª£c t·∫°o th·ªß c√¥ng ƒë·ªÉ tr√°nh c√°c kho·∫£n ph√≠ ph√°t sinh.\nGiai ƒëo·∫°n 1: D·ªçn d·∫πp d·ªØ li·ªáu th·ªß c√¥ng (Tr∆∞·ªõc khi CDK Destroy) CDK t·ª± ƒë·ªông x√≥a h·∫ßu h·∫øt c√°c t√†i nguy√™n nh∆∞ng kh√¥ng x√≥a n·ªôi dung trong S3 buckets. T·∫•t c·∫£ bucket l∆∞u log s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i tr·ª´ bucket aws-incident-response-automation-dashboard. Bucketaws-incident-response-automation-dashboard bu·ªôc ph·∫£i l√†m tr·ªëng n·ªôi dung tr∆∞·ªõc khi ti·∫øn h√†nh CDK destroy.\nH∆∞·ªõng d·∫´n l√†m tr·ªëng Buckets:\nM·ªü Amazon S3 Console trong tr√¨nh duy·ªát c·ªßa b·∫°n. ƒê·ªëi bucket aws-incident-response-automation-dashboard: Nh·∫•n v√†o t√™n bucket. ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn tab \u0026ldquo;Objects\u0026rdquo;. Nh·∫•n n√∫t \u0026ldquo;Empty\u0026rdquo;. L√†m theo c√°c l·ªùi nh·∫Øc ƒë·ªÉ x√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ c√°c objects. Giai ƒëo·∫°n 2: CDK Stack Destruction B∆∞·ªõc n√†y s·ª≠ d·ª•ng CDK CLI ƒë·ªÉ ph√° h·ªßy t·∫•t c·∫£ c√°c t√†i nguy√™n ƒë∆∞·ª£c cung c·∫•p b·ªüi CloudFormation stack.\nƒê·∫£m b·∫£o m√¥i tr∆∞·ªùng ·∫£o (Virtual Environment) ƒëang ho·∫°t ƒë·ªông\nN·∫øu b·∫°n ƒë√£ t·∫Øt m√¥i tr∆∞·ªùng Python, h√£y k√≠ch ho·∫°t l·∫°i n√≥ (v√≠ d·ª•: source .venv/bin/activate). ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn Project Root\nƒê·∫£m b·∫£o b·∫°n ƒëang ·ªü th∆∞ m·ª•c ch√≠nh n∆°i ch·ª©a file cdk.json. Th·ª±c thi l·ªánh Destroy\nCh·∫°y l·ªánh ƒë·ªÉ ph√° h·ªßy t·∫•t c·∫£ c√°c stacks ƒë√£ tri·ªÉn khai. Khi ƒë∆∞·ª£c nh·∫Øc, g√µ y ƒë·ªÉ ch·∫•p nh·∫≠n vi·ªác x√≥a. $ cdk destroy --all Giai ƒëo·∫°n 3: D·ªçn d·∫πp sau khi ph√° h·ªßy B∆∞·ªõc n√†y gi·∫£i quy·∫øt vi·ªác d·ªçn d·∫πp th·ªß c√¥ng c√°c t√†i nguy√™n c√≤n s√≥t l·∫°i.\nX√≥a c√°c S3 Buckets c√≤n l·∫°i\nL·ªánh cdk destroy s·∫Ω x√≥a c√°c S3 buckets tr·ªëng. N·∫øu c√≥ nhu c·∫ßu x√≥a c√°c buckets l∆∞u log, h√£y l√†m tr·ªëng v√† x√≥a ch√∫ng ngay b√¢y gi·ªù qua S3 Console. V√¥ hi·ªáu h√≥a Amazon GuardDuty\nV√†o GuardDuty Console ‚Üí Settings ‚Üí General. X√°c minh d·ªãch v·ª• ƒë√£ b·ªã v√¥ hi·ªáu h√≥a ƒë·ªÉ ƒë·∫£m b·∫£o ng·ª´ng t√≠nh ph√≠. X√≥a Cognito User v√† Pool\nV√†o Cognito Console ‚Üí User pools. X√≥a test user b·∫°n ƒë√£ t·∫°o. X√≥a User Pool ƒë√£ t·∫°o cho dashboard. X√≥a SES Identity\nV√†o Amazon SES Console ‚Üí Verified Identities. X√≥a sender email identity (sender_email) b·∫°n ƒë√£ x√°c minh. H·ªßy k√≠ch ho·∫°t m√¥i tr∆∞·ªùng ·∫£o\nH·ªßy k√≠ch ho·∫°t m√¥i tr∆∞·ªùng ·∫£o Python: $ deactivate "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/2-prerequiste/","title":"ƒêi·ªÅu ki·ªán ti√™n quy·∫øt","tags":[],"description":"","content":"C√°c y√™u c·∫ßu v·ªÅ Truy c·∫≠p v√† Th√¥ng tin Tr∆∞·ªõc khi ti·∫øn h√†nh thi·∫øt l·∫≠p H·ªá th·ªëng Ph·∫£n h·ªìi S·ª± c·ªë v√† ƒêi·ªÅu tra s·ªë AWS T·ª± ƒë·ªông (Automated AWS Incident Response and Forensics System), h√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ thu th·∫≠p ƒë·ªß c√°c th√¥ng tin v√† quy·ªÅn truy c·∫≠p c·∫ßn thi·∫øt d∆∞·ªõi ƒë√¢y.\nüîë Truy c·∫≠p \u0026amp; ƒê·ªãnh danh T√†i kho·∫£n AWS v·ªõi Quy·ªÅn Qu·∫£n tr·ªã (Administrative Access) B·∫°n c·∫ßn to√†n quy·ªÅn qu·∫£n tr·ªã ƒë·ªÉ t·∫°o t√†i nguy√™n tr√™n nhi·ªÅu d·ªãch v·ª• AWS. Truy c·∫≠p v√†o AWS Management Console. AWS Account ID c·ªßa b·∫°n ƒê·ªãnh d·∫°ng: s·ªë c√≥ 12 ch·ªØ s·ªë (v√≠ d·ª•: 123456789012). Placeholder: Thay th·∫ø ACCOUNT_ID trong to√†n b·ªô h∆∞·ªõng d·∫´n. AWS Region M·ª•c ti√™u Ch·ªçn region n∆°i b·∫°n s·∫Ω tri·ªÉn khai h·ªá th·ªëng (v√≠ d·ª•: us-east-1). Placeholder: Thay th·∫ø REGION trong to√†n b·ªô h∆∞·ªõng d·∫´n. VPC ID M·ªôt VPC c√≥ √≠t nh·∫•t m·ªôt subnet ƒë∆∞·ª£c y√™u c·∫ßu cho VPC Flow Logs. Placeholder: Thay th·∫ø YOUR_VPC_ID trong h∆∞·ªõng d·∫´n. ƒê·ªãa ch·ªâ Email ƒë√£ x√°c th·ª±c Amazon SES C·∫ßn thi·∫øt ƒë·ªÉ g·ª≠i v√† nh·∫≠n th√¥ng b√°o qua email. X√°c th·ª±c ƒë·ªãa ch·ªâ n√†y trong SES Console. Placeholder: Thay th·∫ø YOUR_VERIFIED_EMAIL@example.com. Slack Webhook URL (T√πy ch·ªçn) N·∫øu b·∫°n mu·ªën nh·∫≠n th√¥ng b√°o qua Slack, h√£y l·∫•y webhook URL t·ª´ Slack workspace c·ªßa b·∫°n. Placeholder: Thay th·∫ø YOUR_SLACK_WEBHOOK_URL. "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.2-guardduty-etl/","title":"M√£ GuardDuty ETL","tags":[],"description":"","content":" import json import boto3 import gzip import os from datetime import datetime from urllib.parse import unquote_plus s3_client = boto3.client(\u0026#39;s3\u0026#39;) DATABASE_NAME = os.environ.get(\u0026#34;DATABASE_NAME\u0026#34;, \u0026#34;security_logs\u0026#34;) TABLE_NAME_GUARDDUTY = os.environ.get(\u0026#34;TABLE_NAME_GUARDDUTY\u0026#34;, \u0026#34;processed_guardduty\u0026#34;) S3_LOCATION_GUARDDUTY = os.environ.get(\u0026#34;S3_LOCATION_GUARDDUTY\u0026#34;, \u0026#34;s3://vel-processed-guardduty/processed-guardduty/\u0026#34;) DESTINATION_BUCKET = os.environ.get(\u0026#34;DESTINATION_BUCKET\u0026#34;, \u0026#34;vel-processed-guardduty\u0026#34;) def promote_network_details(finding_service): if not finding_service: return {} action = finding_service.get(\u0026#39;action\u0026#39;, {}) net_conn_action = action.get(\u0026#39;networkConnectionAction\u0026#39;, {}) if net_conn_action: remote_ip = net_conn_action.get(\u0026#39;remoteIpDetails\u0026#39;, {}).get(\u0026#39;ipAddressV4\u0026#39;) or \\ net_conn_action.get(\u0026#39;remoteIpDetails\u0026#39;, {}).get(\u0026#39;ipAddressV6\u0026#39;) return { \u0026#39;remote_ip\u0026#39;: remote_ip, \u0026#39;remote_port\u0026#39;: net_conn_action.get(\u0026#39;remotePortDetails\u0026#39;, {}).get(\u0026#39;port\u0026#39;), \u0026#39;connection_direction\u0026#39;: net_conn_action.get(\u0026#39;connectionDirection\u0026#39;), \u0026#39;protocol\u0026#39;: net_conn_action.get(\u0026#39;protocol\u0026#39;), } dns_action = action.get(\u0026#39;dnsRequestAction\u0026#39;, {}) if dns_action: return {\u0026#39;dns_domain\u0026#39;: dns_action.get(\u0026#39;domain\u0026#39;), \u0026#39;dns_protocol\u0026#39;: dns_action.get(\u0026#39;protocol\u0026#39;)} port_probe_action = action.get(\u0026#39;portProbeAction\u0026#39;, {}) if port_probe_action and port_probe_action.get(\u0026#39;portProbeDetails\u0026#39;): detail = port_probe_action[\u0026#39;portProbeDetails\u0026#39;][0] return { \u0026#39;scanned_ip\u0026#39;: detail.get(\u0026#39;remoteIpDetails\u0026#39;, {}).get(\u0026#39;ipAddressV4\u0026#39;), \u0026#39;scanned_port\u0026#39;: detail.get(\u0026#39;localPortDetails\u0026#39;, {}).get(\u0026#39;port\u0026#39;), } return {} def promote_api_details(finding_service): if not finding_service: return {} action = finding_service.get(\u0026#39;action\u0026#39;, {}) aws_api_action = action.get(\u0026#39;awsApiCallAction\u0026#39;, {}) if aws_api_action: return { \u0026#39;aws_api_service\u0026#39;: aws_api_action.get(\u0026#39;serviceName\u0026#39;), \u0026#39;aws_api_name\u0026#39;: aws_api_action.get(\u0026#39;api\u0026#39;), \u0026#39;aws_api_caller_type\u0026#39;: aws_api_action.get(\u0026#39;callerType\u0026#39;), \u0026#39;aws_api_error\u0026#39;: aws_api_action.get(\u0026#39;errorCode\u0026#39;), \u0026#39;aws_api_remote_ip\u0026#39;: aws_api_action.get(\u0026#39;remoteIpDetails\u0026#39;, {}).get(\u0026#39;ipAddressV4\u0026#39;), } return {} def promote_resource_details(finding_resource): if not finding_resource: return {} instance_details = finding_resource.get(\u0026#39;instanceDetails\u0026#39;, {}) if instance_details: return { \u0026#39;target_resource_arn\u0026#39;: instance_details.get(\u0026#39;arn\u0026#39;), \u0026#39;instance_id\u0026#39;: instance_details.get(\u0026#39;instanceId\u0026#39;), \u0026#39;resource_region\u0026#39;: instance_details.get(\u0026#39;awsRegion\u0026#39;), \u0026#39;instance_type\u0026#39;: instance_details.get(\u0026#39;instanceType\u0026#39;), \u0026#39;image_id\u0026#39;: instance_details.get(\u0026#39;imageId\u0026#39;), \u0026#39;instance_tags\u0026#39;: instance_details.get(\u0026#39;tags\u0026#39;) } access_key_details = finding_resource.get(\u0026#39;accessKeyDetails\u0026#39;, {}) if access_key_details: return { \u0026#39;access_key_id\u0026#39;: access_key_details.get(\u0026#39;accessKeyId\u0026#39;), \u0026#39;principal_id\u0026#39;: access_key_details.get(\u0026#39;principalId\u0026#39;), \u0026#39;user_name\u0026#39;: access_key_details.get(\u0026#39;userName\u0026#39;), } s3_details = finding_resource.get(\u0026#39;s3BucketDetails\u0026#39;, []) if s3_details: return { \u0026#39;target_resource_arn\u0026#39;: s3_details[0].get(\u0026#39;arn\u0026#39;), \u0026#39;s3_bucket_name\u0026#39;: s3_details[0].get(\u0026#39;name\u0026#39;), } return {} def process_guardduty_log(bucket, key): response = s3_client.get_object(Bucket=bucket, Key=key) if key.endswith(\u0026#39;.gz\u0026#39;): content = gzip.decompress(response[\u0026#39;Body\u0026#39;].read()).decode(\u0026#39;utf-8\u0026#39;) else: content = response[\u0026#39;Body\u0026#39;].read().decode(\u0026#39;utf-8\u0026#39;) processed_findings = [] for line in content.splitlines(): if not line: continue try: finding = json.loads(line) except json.JSONDecodeError: print(f\u0026#34;Skipping malformed JSON line in {key}\u0026#34;); continue finding_type = finding.get(\u0026#39;type\u0026#39;, \u0026#39;UNKNOWN\u0026#39;) finding_service = finding.get(\u0026#39;service\u0026#39;, {}) network_fields = promote_network_details(finding_service) api_fields = promote_api_details(finding_service) resource_fields = promote_resource_details(finding.get(\u0026#39;resource\u0026#39;, {})) created_at_str = finding.get(\u0026#39;createdAt\u0026#39;) event_last_seen_str = finding_service.get(\u0026#39;eventLastSeen\u0026#39;) dt_obj = datetime.now() if event_last_seen_str: try: dt_obj = datetime.strptime(event_last_seen_str, \u0026#39;%Y-%m-%dT%H:%M:%S.%fZ\u0026#39;) except ValueError: try: dt_obj = datetime.strptime(event_last_seen_str, \u0026#39;%Y-%m-%dT%H:%M:%SZ\u0026#39;) except ValueError: pass elif created_at_str: try: dt_obj = datetime.strptime(created_at_str, \u0026#39;%Y-%m-%dT%H:%M:%S.%fZ\u0026#39;) except ValueError: try: dt_obj = datetime.strptime(created_at_str, \u0026#39;%Y-%m-%dT%H:%M:%SZ\u0026#39;) except ValueError: pass processed_record = { \u0026#39;finding_id\u0026#39;: finding.get(\u0026#39;id\u0026#39;), \u0026#39;finding_type\u0026#39;: finding_type, \u0026#39;title\u0026#39;: finding.get(\u0026#39;title\u0026#39;), \u0026#39;severity\u0026#39;: finding.get(\u0026#39;severity\u0026#39;), \u0026#39;account_id\u0026#39;: finding.get(\u0026#39;accountId\u0026#39;), \u0026#39;region\u0026#39;: finding.get(\u0026#39;region\u0026#39;), \u0026#39;created_at\u0026#39;: created_at_str, \u0026#39;event_last_seen\u0026#39;: event_last_seen_str, **network_fields, **api_fields, **resource_fields, \u0026#39;date\u0026#39;: dt_obj.strftime(\u0026#39;%Y-%m-%d\u0026#39;), \u0026#39;service_raw\u0026#39;: json.dumps(finding_service), \u0026#39;resource_raw\u0026#39;: json.dumps(finding.get(\u0026#39;resource\u0026#39;, {})), \u0026#39;metadata_raw\u0026#39;: json.dumps(finding.get(\u0026#39;metadata\u0026#39;, {})), } processed_findings.append(processed_record) return processed_findings def save_processed_data(processed_events, source_key): if not processed_events: return first_event = processed_events[0] date_str = first_event.get(\u0026#39;date\u0026#39;, datetime.now().strftime(\u0026#39;%Y-%m-%d\u0026#39;)) original_filename = source_key.split(\u0026#39;/\u0026#39;)[-1].replace(\u0026#39;.gz\u0026#39;, \u0026#39;\u0026#39;).replace(\u0026#39;.json\u0026#39;, \u0026#39;\u0026#39;) output_key = f\u0026#34;processed-guardduty/date={date_str}/{original_filename}_processed.jsonl.gz\u0026#34; json_lines = \u0026#34;\u0026#34; for event in processed_events: event_to_dump = event.copy() json_lines += json.dumps(event_to_dump) + \u0026#34;\\n\u0026#34; compressed_data = gzip.compress(json_lines.encode(\u0026#39;utf-8\u0026#39;)) s3_client.put_object( Bucket=DESTINATION_BUCKET, Key=output_key, Body=compressed_data, ContentType=\u0026#39;application/jsonl\u0026#39;, ContentEncoding=\u0026#39;gzip\u0026#39; ) print(f\u0026#34;Saved processed data to: s3://{DESTINATION_BUCKET}/{output_key}\u0026#34;) def lambda_handler(event, context): for record in event[\u0026#39;Records\u0026#39;]: bucket = record[\u0026#39;s3\u0026#39;][\u0026#39;bucket\u0026#39;][\u0026#39;name\u0026#39;] key = unquote_plus(record[\u0026#39;s3\u0026#39;][\u0026#39;object\u0026#39;][\u0026#39;key\u0026#39;]) print(f\u0026#34;Processing GuardDuty finding file: s3://{bucket}/{key}\u0026#34;) try: processed_findings = process_guardduty_log(bucket, key) save_processed_data(processed_findings, key) print(f\u0026#34;Successfully processed {len(processed_findings)} findings from {key}\u0026#34;) except Exception as e: print(f\u0026#34;Error processing {key}: {str(e)}\u0026#34;) raise e return { \u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: json.dumps(\u0026#39;GuardDuty findings processed successfully\u0026#39;) } "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/5-processing-setup/5.2-create-aws-glue-database-and-tables/","title":"T·∫°o AWS Glue Database v√† Tables","tags":[],"description":"","content":"T·∫°o AWS Glue Database v√† Tables T·∫°o Database M·ªü Glue Console ‚Üí Databases ‚Üí Add database\nDatabase name: security_logs\nCreate database\nT·∫°o Tables (S·ª≠ d·ª•ng Athena DDL) M·ªü Athena Console\nƒê·∫∑t v·ªã tr√≠ l∆∞u k·∫øt qu·∫£ truy v·∫•n (query result location): s3://athena-query-results-ACCOUNT_ID-REGION/\nCh·ªçn database: security_logs\nT·∫°o b·∫£ng processed_cloudtrail Ch·∫°y DDL n√†y trong Athena (thay th·∫ø ACCOUNT_ID v√† REGION):\nCREATE EXTERNAL TABLE IF NOT EXISTS security_logs.processed_cloudtrail ( `eventtime` string, `eventname` string, `eventsource` string, `awsregion` string, `sourceipaddress` string, `useragent` string, `useridentity` struct\u0026lt; type:string, invokedby:string, principalid:string, arn:string, accountid:string, accesskeyid:string, username:string, sessioncontext:struct\u0026lt; attributes:map\u0026lt;string,string\u0026gt;, sessionissuer:struct\u0026lt; type:string, principalid:string, arn:string, accountid:string, username:string \u0026gt; \u0026gt;, inscopeof:struct\u0026lt; issuertype:string, credentialsissuedto:string \u0026gt; \u0026gt;, `requestparameters` string, `responseelements` string, `resources` array\u0026lt;struct\u0026lt;arn:string,type:string\u0026gt;\u0026gt;, `recipientaccountid` string, `serviceeventdetails` string, `errorcode` string, `errormessage` string, `hour` string, `usertype` string, `username` string, `isconsolelogin` boolean, `isfailedlogin` boolean, `isrootuser` boolean, `isassumedrole` boolean, `ishighriskevent` boolean, `isprivilegedaction` boolean, `isdataaccess` boolean, `target_bucket` string, `target_key` string, `target_username` string, `target_rolename` string, `target_policyname` string, `new_access_key` string, `new_instance_id` string, `target_group_id` string, `identity_principalid` string ) PARTITIONED BY ( `date` string ) ROW FORMAT SERDE \u0026#39;org.openx.data.jsonserde.JsonSerDe\u0026#39; WITH SERDEPROPERTIES ( \u0026#39;serialization.format\u0026#39; = \u0026#39;1\u0026#39; ) LOCATION \u0026#39;s3://processed-cloudtrail-logs-ACCOUNT_ID-REGION/processed-cloudtrail/\u0026#39; TBLPROPERTIES ( \u0026#39;projection.enabled\u0026#39; = \u0026#39;true\u0026#39;, \u0026#39;projection.date.type\u0026#39; = \u0026#39;date\u0026#39;, \u0026#39;projection.date.format\u0026#39; = \u0026#39;yyyy-MM-dd\u0026#39;, \u0026#39;projection.date.range\u0026#39; = \u0026#39;2025-01-01,NOW\u0026#39;, \u0026#39;projection.date.interval\u0026#39; = \u0026#39;1\u0026#39;, \u0026#39;projection.date.interval.unit\u0026#39; = \u0026#39;DAYS\u0026#39;, \u0026#39;storage.location.template\u0026#39; = \u0026#39;s3://processed-cloudtrail-logs-ACCOUNT_ID-REGION/processed-cloudtrail/date=${date}/\u0026#39;, \u0026#39;classification\u0026#39; = \u0026#39;json\u0026#39;, \u0026#39;compressionType\u0026#39; = \u0026#39;gzip\u0026#39; ); T·∫°o b·∫£ng processed_guardduty Ch·∫°y DDL n√†y trong Athena:\nCREATE EXTERNAL TABLE IF NOT EXISTS security_logs.processed_guardduty ( `finding_id` string, `finding_type` string, `title` string, `severity` double, `account_id` string, `region` string, `created_at` string, `event_last_seen` string, `remote_ip` string, `remote_port` int, `connection_direction` string, `protocol` string, `dns_domain` string, `dns_protocol` string, `scanned_ip` string, `scanned_port` int, `aws_api_service` string, `aws_api_name` string, `aws_api_caller_type` string, `aws_api_error` string, `aws_api_remote_ip` string, `target_resource_arn` string, `instance_id` string, `instance_type` string, `image_id` string, `instance_tags` string, `resource_region` string, `access_key_id` string, `principal_id` string, `user_name` string, `s3_bucket_name` string, `service_raw` string, `resource_raw` string, `metadata_raw` string ) PARTITIONED BY ( `date` string ) ROW FORMAT SERDE \u0026#39;org.openx.data.jsonserde.JsonSerDe\u0026#39; WITH SERDEPROPERTIES ( \u0026#39;serialization.format\u0026#39; = \u0026#39;1\u0026#39; ) LOCATION \u0026#39;s3://processed-guardduty-findings-ACCOUNT_ID-REGION/processed-guardduty/\u0026#39; TBLPROPERTIES ( \u0026#39;classification\u0026#39; = \u0026#39;json\u0026#39;, \u0026#39;compressionType\u0026#39; = \u0026#39;gzip\u0026#39;, \u0026#39;projection.enabled\u0026#39; = \u0026#39;true\u0026#39;, \u0026#39;projection.date.type\u0026#39; = \u0026#39;date\u0026#39;, \u0026#39;projection.date.range\u0026#39; = \u0026#39;2025-01-01,NOW\u0026#39;, \u0026#39;projection.date.format\u0026#39; = \u0026#39;yyyy-MM-dd\u0026#39;, \u0026#39;projection.date.interval\u0026#39; = \u0026#39;1\u0026#39;, \u0026#39;projection.date.interval.unit\u0026#39; = \u0026#39;DAYS\u0026#39;, \u0026#39;storage.location.template\u0026#39; = \u0026#39;s3://processed-guardduty-findings-ACCOUNT_ID-REGION/processed-guardduty/date=${date}/\u0026#39; ); T·∫°o b·∫£ng vpc_logs Ch·∫°y DDL n√†y trong Athena:\nCREATE EXTERNAL TABLE IF NOT EXISTS security_logs.vpc_logs ( `version` string, `account_id` string, `region` string, `vpc_id` string, `query_timestamp` string, `query_name` string, `query_type` string, `query_class` string, `rcode` string, `answers` string, `srcaddr` string, `srcport` int, `transport` string, `srcids_instance` string, `timestamp` string ) PARTITIONED BY ( `date` string ) ROW FORMAT SERDE \u0026#39;org.openx.data.jsonserde.JsonSerDe\u0026#39; WITH SERDEPROPERTIES ( \u0026#39;serialization.format\u0026#39; = \u0026#39;1\u0026#39;, \u0026#39;ignore.malformed.json\u0026#39; = \u0026#39;true\u0026#39; ) LOCATION \u0026#39;s3://processed-cloudwatch-logs-ACCOUNT_ID-REGION/vpc-logs/\u0026#39; TBLPROPERTIES ( \u0026#39;projection.enabled\u0026#39; = \u0026#39;true\u0026#39;, \u0026#39;projection.date.type\u0026#39; = \u0026#39;date\u0026#39;, \u0026#39;projection.date.format\u0026#39; = \u0026#39;yyyy-MM-dd\u0026#39;, \u0026#39;projection.date.range\u0026#39; = \u0026#39;2025-01-01,NOW\u0026#39;, \u0026#39;projection.date.interval\u0026#39; = \u0026#39;1\u0026#39;, \u0026#39;projection.date.interval.unit\u0026#39; = \u0026#39;DAYS\u0026#39;, \u0026#39;storage.location.template\u0026#39; = \u0026#39;s3://processed-cloudwatch-logs-ACCOUNT_ID-REGION/vpc-logs/date=${date}/\u0026#39;, \u0026#39;classification\u0026#39; = \u0026#39;json\u0026#39;, \u0026#39;compressionType\u0026#39; = \u0026#39;gzip\u0026#39; ); T·∫°o b·∫£ng eni_flow_logs Ch·∫°y DDL n√†y trong Athena:\nCREATE EXTERNAL TABLE IF NOT EXISTS security_logs.eni_flow_logs ( `version` int, `account_id` string, `interface_id` string, `srcaddr` string, `dstaddr` string, `srcport` int, `dstport` int, `protocol` int, `packets` bigint, `bytes` bigint, `start_time` bigint, `end_time` bigint, `action` string, `log_status` string, `timestamp_str` string ) PARTITIONED BY ( `date` string ) ROW FORMAT SERDE \u0026#39;org.openx.data.jsonserde.JsonSerDe\u0026#39; WITH SERDEPROPERTIES ( \u0026#39;serialization.format\u0026#39; = \u0026#39;1\u0026#39; ) LOCATION \u0026#39;s3://processed-cloudwatch-logs-ACCOUNT_ID-REGION/eni-flow-logs/\u0026#39; TBLPROPERTIES ( \u0026#39;projection.enabled\u0026#39; = \u0026#39;true\u0026#39;, \u0026#39;projection.date.type\u0026#39; = \u0026#39;date\u0026#39;, \u0026#39;projection.date.format\u0026#39; = \u0026#39;yyyy-MM-dd\u0026#39;, \u0026#39;projection.date.range\u0026#39; = \u0026#39;2025-01-01,NOW\u0026#39;, \u0026#39;projection.date.interval\u0026#39; = \u0026#39;1\u0026#39;, \u0026#39;projection.date.interval.unit\u0026#39; = \u0026#39;DAYS\u0026#39;, \u0026#39;storage.location.template\u0026#39; = \u0026#39;s3://processed-cloudwatch-logs-ACCOUNT_ID-REGION/eni-flow-logs/date=${date}/\u0026#39;, \u0026#39;classification\u0026#39; = \u0026#39;json\u0026#39;, \u0026#39;compressionType\u0026#39; = \u0026#39;gzip\u0026#39; ); "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.3-create-iam-roles-and-policies/3.3.2-create-service-roles/","title":"T·∫°o Service Roles","tags":[],"description":"","content":"T·∫°o Firehose Roles T·∫°o CloudTrailFirehoseRole M·ªü IAM Console ‚Üí Roles ‚Üí Create role\nCh·ªçn trusted entity:\nTrusted entity type: AWS service Use case: Ch·ªçn \u0026ldquo;Kinesis\u0026rdquo; ‚Üí \u0026ldquo;Kinesis Firehose\u0026rdquo; Nh·∫•n \u0026ldquo;Next\u0026rdquo; Th√™m permissions:\nB·ªè qua vi·ªác th√™m managed policies (ch√∫ng ta s·∫Ω th√™m inline policy) Nh·∫•n \u0026ldquo;Next\u0026rdquo; ƒê·∫∑t t√™n v√† t·∫°o:\nRole name: CloudTrailFirehoseRole Description: Allows Firehose to write CloudTrail logs to S3 Nh·∫•n \u0026ldquo;Create role\u0026rdquo; Th√™m inline policy:\nPolicy name: FirehosePolicy Policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetBucketLocation\u0026#34;, \u0026#34;s3:ListBucket\u0026#34;, \u0026#34;s3:PutObject\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::processed-cloudtrail-logs-ACCOUNT_ID-REGION\u0026#34;, \u0026#34;arn:aws:s3:::processed-cloudtrail-logs-ACCOUNT_ID-REGION/*\u0026#34; ] } ] } T·∫°o CloudWatchFirehoseRole Role name: CloudWatchFirehoseRole Description: Allows Firehose to write CloudWatch logs to S3 Trusted entity: Kinesis Firehose Inline policy name: FirehosePolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetBucketLocation\u0026#34;, \u0026#34;s3:ListBucket\u0026#34;, \u0026#34;s3:PutObject\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::processed-cloudwatch-logs-ACCOUNT_ID-REGION\u0026#34;, \u0026#34;arn:aws:s3:::processed-cloudwatch-logs-ACCOUNT_ID-REGION/*\u0026#34; ] } ] } T·∫°o Step Functions Role T·∫°o StepFunctionsRole T·∫°o role:\nTrusted entity: Step Functions Role name: StepFunctionsRole Description: Execution role for Incident Response Step Functions Th√™m HAI inline policies:\nPolicy 1: LambdaInvokePolicy\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;lambda:InvokeFunction\u0026#34;, \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:lambda:REGION:ACCOUNT_ID:function:ir-isolate-ec2-lambda\u0026#34;, \u0026#34;arn:aws:lambda:REGION:ACCOUNT_ID:function:ir-parse-findings-lambda\u0026#34;, \u0026#34;arn:aws:lambda:REGION:ACCOUNT_ID:function:ir-quarantine-iam-lambda\u0026#34; ] } ] } Policy 2: EC2AutoScalingPolicy\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;autoscaling:DescribeAutoScalingInstances\u0026#34;, \u0026#34;autoscaling:DetachInstances\u0026#34;, \u0026#34;autoscaling:UpdateAutoScalingGroup\u0026#34;, \u0026#34;ec2:CreateSnapshot\u0026#34;, \u0026#34;ec2:CreateTags\u0026#34;, \u0026#34;ec2:DescribeVolumes\u0026#34;, \u0026#34;ec2:ModifyInstanceAttribute\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } T·∫°o EventBridge Role T·∫°o IncidentResponseStepFunctionsEventRole Role name: IncidentResponseStepFunctionsEventRole Description: Allows EventBridge to trigger Step Functions Trusted entity: EventBridge Inline policy name: StartStepFunctionsPolicy Inline policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;states:StartExecution\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:REGION:ACCOUNT_ID:stateMachine:IncidentResponseStepFunctions\u0026#34; } ] } T·∫°o VPC Flow Logs Role T·∫°o FlowLogsIAMRole T·∫°o role:\nTrusted entity: EC2 (will edit trust policy - s·∫Ω ch·ªânh s·ª≠a trust policy sau) Role name: FlowLogsIAMRole Ch·ªânh s·ª≠a trust relationship th√†nh:\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;vpc-flow-logs.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;sts:AssumeRole\u0026#34; } ] } Th√™m inline policy: Policy name: FlowLogsPolicy Policy JSON: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;logs:CreateLogGroup\u0026#34;, \u0026#34;logs:CreateLogStream\u0026#34;, \u0026#34;logs:DescribeLogGroups\u0026#34;, \u0026#34;logs:DescribeLogStreams\u0026#34;, \u0026#34;logs:PutLogEvents\u0026#34; ], \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } T·∫°o Glue Role T·∫°o GlueCloudWatchRole Role name: GlueCloudWatchRole Description: Allows Glue to access S3 and CloudWatch Logs Trusted entity: Glue Managed policies (ƒë√≠nh k√®m 3 policies): AWSGlueServiceRole CloudWatchLogsReadOnlyAccess AmazonS3FullAccess Kh√¥ng c·∫ßn inline policies "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.2-set-up-s3-buckets-policies/","title":"Thi·∫øt l·∫≠p S3 buckets policies","tags":[],"description":"","content":"Trong ph·∫ßn n√†y, b·∫°n s·∫Ω c·∫•u h√¨nh bucket policy cho bucket log ch√≠nh ƒë·ªÉ cho ph√©p CloudTrail, GuardDuty, v√† CloudWatch Logs ghi log.\nC·∫•u h√¨nh Bucket Policy ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn bucket log ch√≠nh: Trong S3 Console, nh·∫•n v√†o incident-response-log-list-bucket-ACCOUNT_ID-REGION M·ªü tab Permissions:\nNh·∫•n v√†o tab \u0026ldquo;Permissions\u0026rdquo; Cu·ªôn ƒë·∫øn Bucket policy:\nCu·ªôn xu·ªëng ph·∫ßn \u0026ldquo;Bucket policy\u0026rdquo; Nh·∫•n \u0026ldquo;Edit\u0026rdquo; D√°n bucket policy: Copy JSON policy sau Quan tr·ªçng: Thay th·∫ø ACCOUNT_ID v√† REGION b·∫±ng gi√° tr·ªã th·ª±c t·∫ø c·ªßa b·∫°n trong policy { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;AllowGuardDutyPutObject\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;guardduty.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:PutObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:guardduty:REGION:ACCOUNT_ID:detector/*\u0026#34; } } }, { \u0026#34;Sid\u0026#34;: \u0026#34;AllowGuardDutyGetBucketLocation\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;guardduty.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetBucketLocation\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:guardduty:REGION:ACCOUNT_ID:detector/*\u0026#34; } } }, { \u0026#34;Sid\u0026#34;: \u0026#34;AllowCloudWatchLogsGetBucketAcl\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.REGION.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetBucketAcl\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:logs:REGION:ACCOUNT_ID:log-group:*\u0026#34; } } }, { \u0026#34;Sid\u0026#34;: \u0026#34;AllowCloudWatchLogsPutObject\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;logs.REGION.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:PutObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:logs:REGION:ACCOUNT_ID:log-group:*\u0026#34; } } }, { \u0026#34;Sid\u0026#34;: \u0026#34;AllowCloudTrailAclCheck\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;cloudtrail.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetBucketAcl\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:cloudtrail:REGION:ACCOUNT_ID:trail/*\u0026#34; } } }, { \u0026#34;Sid\u0026#34;: \u0026#34;AllowCloudTrailWrite\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;cloudtrail.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:PutObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/AWSLogs/ACCOUNT_ID/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;StringEquals\u0026#34;: { \u0026#34;s3:x-amz-acl\u0026#34;: \u0026#34;bucket-owner-full-control\u0026#34;, \u0026#34;aws:SourceAccount\u0026#34;: \u0026#34;ACCOUNT_ID\u0026#34; }, \u0026#34;ArnLike\u0026#34;: { \u0026#34;aws:SourceArn\u0026#34;: \u0026#34;arn:aws:cloudtrail:REGION:ACCOUNT_ID:trail/*\u0026#34; } } } ] } Nh·∫•n \u0026ldquo;Save changes\u0026rdquo;\nX√°c minh policy ƒë√£ l∆∞u: B·∫°n s·∫Ω th·∫•y policy hi·ªÉn th·ªã trong ph·∫ßn Bucket policy\n"},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.3-setup-api-gateway/","title":"C√†i ƒë·∫∑t API Gateway","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t m·ªôt API Gateway ƒë·ªÉ ƒë·ªãnh tuy·∫øn cu·ªôc g·ªçi api t·ª´ dashboard t·ªõi Lambda.\nT·∫°o API Gateway M·ªü API Gateway Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/apigateway/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí API Gateway T·∫°o API:\nNh·∫•n Create API Ch·ªçn REST API v√† nh·∫•n Build S·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y ƒë·ªÉ t·∫°o: Ch·ªçn New API Name: dashboard-api API endpoint type: Regional Security policy: SecurityPolicy_TLS13_1_3_2025_09 Endpoint access mode: Basic IP address type: IPv4 T·∫°o Resources:\nB·∫≠t CORS cho root resource Nh·∫•n Create resource v√† ƒë·∫∑t t√™n l√† logs Sau ƒë√≥ nh·∫•n v√†o t√†i nguy√™n /logs v·ª´a t·∫°o v√† nh·∫•n Create Resource ƒë·ªÉ t·∫°o t√†i nguy√™n con c·ªßa /logs ƒê·∫∑t t√™n l√† cloudtrail v√† b·∫≠t CORS L·∫∑p l·∫°i ba l·∫ßn n·ªØa cho eni_logs, guardduty v√† vpc T·∫°o methods:\nNh·∫•n v√†o /cloudtrail v·ª´a t·∫°o v√† nh·∫•n Create method\nTrong ph·∫ßn t·∫°o method, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y:\nMethod type: GET Intergration type: Lambda function B·∫≠t Lambda proxy intergration ch·ªçn Buffered Lambda function: ch·ªçn region c·ªßa b·∫°n, t√¨m ki·∫øm dashboard-query v√† ch·ªçn n√≥ Timout: 29000 L·∫∑p l·∫°i ba l·∫ßn n·ªØa cho eni_logs, guardduty v√† vpc\nTri·ªÉn khai API (Deploy API):\nNh·∫•n Deploy API ·ªü g√≥c ph·∫£i Trong ph·∫ßn deploy API, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: Stage: New stage Name: prod Nh·∫•n Deploy "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.3-cloudwatch-etl/","title":"M√£ CloudWatch ETL","tags":[],"description":"","content":"import json import boto3 import gzip import re import os from datetime import datetime, timezone s3 = boto3.client(\u0026#34;s3\u0026#34;) firehose= boto3.client(\u0026#34;firehose\u0026#34;) # -------------------------------------------------- # C·∫§U H√åNH (CONFIG) # -------------------------------------------------- SOURCE_PREFIX = \u0026#34;exportedlogs/vpc-dns-logs/\u0026#34; FIREHOSE_STREAM_NAME = os.environ.get(\u0026#34;FIREHOSE_STREAM_NAME\u0026#34;) VPC_RE = re.compile(r\u0026#34;/(vpc-[0-9A-Za-z\\-]+)\u0026#34;) ISO_TS_RE = re.compile(r\u0026#34;^\\d{4}-\\d{2}-\\d{2}T\u0026#34;) def read_gz(bucket, key): obj = s3.get_object(Bucket=bucket, Key=key) with gzip.GzipFile(fileobj=obj[\u0026#34;Body\u0026#34;]) as f: return f.read().decode(\u0026#34;utf-8\u0026#34;, errors=\u0026#34;replace\u0026#34;) def flatten_once(d): out = {} for k, v in (d or {}).items(): if isinstance(v, dict): for k2, v2 in v.items(): out[f\u0026#34;{k}_{k2}\u0026#34;] = v2 else: out[k] = v return out def safe_int(x): try: return int(x) except: return None def parse_dns_line(line): raw = line.strip() if not raw: return None json_part = raw prefix_ts = None if ISO_TS_RE.match(raw): try: prefix_ts, rest = raw.split(\u0026#34; \u0026#34;, 1) json_part = rest except: pass if not json_part.startswith(\u0026#34;{\u0026#34;): idx = json_part.find(\u0026#34;{\u0026#34;) if idx != -1: json_part = json_part[idx:] try: obj = json.loads(json_part) except: return None flat = flatten_once(obj) if prefix_ts: flat[\u0026#34;_prefix_ts\u0026#34;] = prefix_ts return flat def lambda_handler(event, context): print(f\u0026#34;Received S3 Event. Records: {len(event.get(\u0026#39;Records\u0026#39;, []))}\u0026#34;) firehose_records = [] for record in event.get(\u0026#34;Records\u0026#34;, []): if \u0026#34;s3\u0026#34; not in record: continue bucket = record[\u0026#34;s3\u0026#34;][\u0026#34;bucket\u0026#34;][\u0026#34;name\u0026#34;] key = record[\u0026#34;s3\u0026#34;][\u0026#34;object\u0026#34;][\u0026#34;key\u0026#34;] if not key.startswith(SOURCE_PREFIX) or not key.endswith(\u0026#34;.gz\u0026#34;): print(f\u0026#34;Skipping file: {key}\u0026#34;) continue print(f\u0026#34;Processing S3 file: {key}\u0026#34;) # Tr√≠ch xu·∫•t VPC ID t·ª´ ƒë∆∞·ªùng d·∫´n file (Extract VPC ID from file path) vpc_id_match = VPC_RE.search(key) vpc_id = vpc_id_match.group(1) if vpc_id_match else \u0026#34;unknown\u0026#34; # ƒê·ªçc v√† x·ª≠ l√Ω n·ªôi dung file (Read and process file content) content = read_gz(bucket, key) if not content: continue for line in content.splitlines(): r = parse_dns_line(line) if not r: continue # T·∫°o flattened JSON record (Create flattened JSON record) out = { \u0026#34;version\u0026#34;: r.get(\u0026#34;version\u0026#34;), \u0026#34;account_id\u0026#34;: r.get(\u0026#34;account_id\u0026#34;), \u0026#34;region\u0026#34;: r.get(\u0026#34;region\u0026#34;), \u0026#34;vpc_id\u0026#34;: r.get(\u0026#34;vpc_id\u0026#34;, vpc_id), \u0026#34;query_timestamp\u0026#34;: r.get(\u0026#34;query_timestamp\u0026#34;), \u0026#34;query_name\u0026#34;: r.get(\u0026#34;query_name\u0026#34;), \u0026#34;query_type\u0026#34;: r.get(\u0026#34;query_type\u0026#34;), \u0026#34;query_class\u0026#34;: r.get(\u0026#34;query_class\u0026#34;), \u0026#34;rcode\u0026#34;: r.get(\u0026#34;rcode\u0026#34;), \u0026#34;answers\u0026#34;: json.dumps(r.get(\u0026#34;answers\u0026#34;), ensure_ascii=False), \u0026#34;srcaddr\u0026#34;: r.get(\u0026#34;srcaddr\u0026#34;), \u0026#34;srcport\u0026#34;: safe_int(r.get(\u0026#34;srcport\u0026#34;)), \u0026#34;transport\u0026#34;: r.get(\u0026#34;transport\u0026#34;), \u0026#34;srcids_instance\u0026#34;: r.get(\u0026#34;srcids_instance\u0026#34;), \u0026#34;timestamp\u0026#34;: (r.get(\u0026#34;query_timestamp\u0026#34;) or r.get(\u0026#34;timestamp\u0026#34;) or r.get(\u0026#34;_prefix_ts\u0026#34;)) } # Th√™m d√≤ng m·ªõi cho ƒë·ªãnh d·∫°ng JSONL (Add newline for JSONL format) json_row = json.dumps(out, ensure_ascii=False) + \u0026#34;\\n\u0026#34; firehose_records.append({\u0026#39;Data\u0026#39;: json_row}) # G·ª≠i ƒë·∫øn Firehose theo batch 500 (Send to Firehose in batches of 500) if firehose_records: total_records = len(firehose_records) print(f\u0026#34;Sending {total_records} records to Firehose...\u0026#34;) batch_size = 500 for i in range(0, total_records, batch_size): batch = firehose_records[i:i + batch_size] try: response = firehose.put_record_batch( DeliveryStreamName=FIREHOSE_STREAM_NAME, Records=batch ) if response[\u0026#39;FailedPutCount\u0026#39;] \u0026gt; 0: print(f\u0026#34;Warning: {response[\u0026#39;FailedPutCount\u0026#39;]} records failed\u0026#34;) except Exception as e: print(f\u0026#34;Firehose error: {e}\u0026#34;) return {\u0026#34;status\u0026#34;: \u0026#34;ok\u0026#34;, \u0026#34;total_records\u0026#34;: len(firehose_records)} "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.3-create-iam-roles-and-policies/3.3.3-create-iam-policy/","title":"T·∫°o IAM Policy","tags":[],"description":"","content":"T·∫°o IAM Quarantine Policy T·∫°o IrQuarantineIAMPolicy ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn IAM Console ‚Üí Policies ‚Üí Create policy\nPolicy JSON:\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Deny\u0026#34;, \u0026#34;Action\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;*\u0026#34; } ] } Policy name: IrQuarantineIAMPolicy Description: Deny-all policy for quarantining compromised IAM users "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/3.3-create-iam-roles-and-policies/","title":"T·∫°o IAM Roles v√† Policies","tags":[],"description":"","content":"Trong ph·∫ßn n√†y, b·∫°n s·∫Ω t·∫°o 17 IAM roles c√πng v·ªõi c√°c policies li√™n quan cho Lambda functions, Firehose streams, Step Functions, v√† c√°c d·ªãch v·ª• kh√°c.\nT·ªïng quan v·ªÅ IAM Roles Lambda Execution Roles (9 roles):\nCloudTrailETLLambdaServiceRole GuardDutyETLLambdaServiceRole CloudWatchETLLambdaServiceRole CloudWatchENIETLLambdaServiceRole CloudWatchExportLambdaServiceRole ParseFindingsLambdaServiceRole IsolateEC2LambdaServiceRole QuarantineIAMLambdaServiceRole AlertDispatchLambdaServiceRole Service Roles (6 roles): 10. CloudTrailFirehoseRole 11. CloudWatchFirehoseRole 12. StepFunctionsRole 13. IncidentResponseStepFunctionsEventRole 14. FlowLogsIAMRole 15. GlueCloudWatchRole\nIAM Policy (1 policy): 16. IrQuarantineIAMPolicy\nN·ªôi dung T·∫°o Lambda Execution Roles T·∫°o Service Roles T·∫°o IAM Policy "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/5-processing-setup/5.3-create-lambda-function-etl-processing/","title":"T·∫°o Lambda Function - X·ª≠ l√Ω ETL","tags":[],"description":"","content":"T·∫°o Lambda Functions - X·ª≠ l√Ω ETL Trong ph·∫ßn n√†y, b·∫°n s·∫Ω t·∫°o 5 Lambda functions ƒë·ªÉ x·ª≠ l√Ω logs v√† g·ª≠i ch√∫ng ƒë·∫øn Kinesis Firehose ho·∫∑c S3.\nincident-response-cloudtrail-etl Runtime: Python 3.12 Handler: CloudTrailETL.lambda_handler Role: CloudTrailETLLambdaServiceRole Timeout: 300s, Memory: 128MB Env: FIREHOSE_STREAM_NAME=cloudtrail-firehose-stream Code: cloudtrail-etl incident-response-guardduty-etl Runtime: Python 3.12 Handler: guardduty_etl.lambda_handler Role: GuardDutyETLLambdaServiceRole Timeout: 300s, Memory: 128MB Env: DESTINATION_BUCKET, S3_LOCATION_GUARDDUTY, DATABASE_NAME, TABLE_NAME_GUARDDUTY Code: guardduty-etl cloudwatch-etl-lambda Runtime: Python 3.12 Handler: cloudwatch_etl.lambda_handler Role: CloudWatchETLLambdaServiceRole Env: FIREHOSE_STREAM_NAME=vpc-dns-firehose-stream Code: cloudwatch-etl cloudwatch-eni-etl-lambda Runtime: Python 3.12 Handler: cloudwatch_eni_etl.lambda_handler Role: CloudWatchENIETLLambdaServiceRole Env: FIREHOSE_STREAM_NAME=vpc-flow-firehose-stream Code: cloudwatch-eni-etl cloudwatch-export-lambda Runtime: Python 3.12 Handler: cloudwatch_autoexport.lambda_handler Role: CloudWatchExportLambdaServiceRole Env: DESTINATION_BUCKET=incident-response-log-list-bucket-ACCOUNT_ID-REGION Code: cloudwatch-autoexport C·∫•u h√¨nh CloudWatch Logs Subscription Filter C·∫•u h√¨nh Subscription Filter M·ªü CloudWatch Console.\n·ªû ngƒÉn ƒëi·ªÅu h∆∞·ªõng b√™n tr√°i, ch·ªçn Log Management.\nNh·∫•n v√†o centralized log group: /aws/incident-response/centralized-logs.\nT·∫°o Subscription Filter:\nNh·∫•n v√†o tab \u0026ldquo;Subscription filters\u0026rdquo;. Nh·∫•n \u0026ldquo;Create Lambda subscription filter\u0026rdquo;. C·∫•u h√¨nh Destination:\nDestination Lambda function: Ch·ªçn function cloudwatch-export-lambda. Log format: Ch·ªçn \u0026ldquo;Other\u0026rdquo;. (ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o d·ªØ li·ªáu log th√¥ ƒë∆∞·ª£c chuy·ªÉn ƒëi hi·ªáu qu·∫£ ƒë·ªÉ Lambda x·ª≠ l√Ω). C·∫•u h√¨nh Log Format v√† Filter:\nSubscription filter name: Nh·∫≠p t√™n m√¥ t·∫£, v√≠ d·ª•, VPC-Log-Export-Filter. Filter pattern: ƒê·ªÉ tr·ªëng tr∆∞·ªùng n√†y blank. (ƒê·∫£m b·∫£o t·∫•t c·∫£ logs trong group ƒë·ªÅu ƒë∆∞·ª£c x·ª≠ l√Ω). Nh·∫•n \u0026ldquo;Start streaming\u0026rdquo;.\nC·∫•u h√¨nh S3 Event Notifications S3 Console ‚Üí incident-response-log-list-bucket-ACCOUNT_ID-REGION ‚Üí Properties ‚Üí Event notifications\nT·∫°o 4 notifications v·ªõi Event types/Object creation/‚úÖAll object create events:\nCloudTrailETLTrigger: Prefix AWSLogs/ACCOUNT_ID/CloudTrail/ ‚Üí Lambda incident-response-cloudtrail-etl VPCDNSLogsTrigger: Prefix exportedlogs/vpc-dns-logs/ ‚Üí Lambda cloudwatch-etl-lambda VPCFlowLogsTrigger: Prefix exportedlogs/vpc-flow-logs/ ‚Üí Lambda cloudwatch-eni-etl-lambda GuardDutyFindingsTrigger: Prefix AWSLogs/ACCOUNT_ID/GuardDuty/ ‚Üí Lambda incident-response-guardduty-etl "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/3-foundation-setup/","title":"Thi·∫øt l·∫≠p n·ªÅn t·∫£ng","tags":[],"description":"","content":"Giai ƒëo·∫°n Thi·∫øt l·∫≠p n·ªÅn t·∫£ng ban ƒë·∫ßu n√†y x√¢y d·ª±ng c√°c ƒëi·ªÅu ki·ªán ti√™n quy·∫øt c·ªët l√µi cho H·ªá th·ªëng Ph·∫£n h·ªìi S·ª± c·ªë T·ª± ƒë·ªông, t·∫≠p trung v√†o vi·ªác tri·ªÉn khai l∆∞u tr·ªØ chuy√™n d·ª•ng v√† ·ªßy quy·ªÅn b·∫£o m·∫≠t thi·∫øt y·∫øu. ƒêi·ªÅu n√†y b·∫Øt bu·ªôc ph·∫£i t·∫°o nƒÉm Amazon S3 buckets an to√†n ƒë·ªÉ thu th·∫≠p v√† x·ª≠ l√Ω log t·∫≠p trung, √°p d·ª•ng Bucket Policy c·∫ßn thi·∫øt ƒë·ªÉ ph√¢n ph·ªëi log an to√†n, v√† ƒë·ªãnh nghƒ©a 17 IAM roles c√πng ch√≠nh s√°ch c√°ch ly (quarantine policy) ƒë·ªÉ th·ª±c thi quy·ªÅn truy c·∫≠p ƒë·∫∑c quy·ªÅn t·ªëi thi·ªÉu (least-privilege access) tr√™n t·∫•t c·∫£ c√°c d·ªãch v·ª• AWS ƒë∆∞·ª£c t√≠ch h·ª£p.\nN·ªôi dung Thi·∫øt l·∫≠p Amazon S3 Bucket C·∫•u h√¨nh S3 Bucket Policy cho Primary Log Bucket T·∫°o IAM Roles v√† Policies "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.4-setup-cloudfront/","title":"C√†i ƒë·∫∑t CloudFront","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω c√†i ƒë·∫∑t m·ªôt CloudFront ƒë·ªÉ cache, ƒë·ªãnh tuy·∫øn v√† truy c·∫≠p web.\nT·∫°o CloudFront Distribution M·ªü CloudFront Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/cloudfront/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí CloudFront T·∫°o Distribution:\nNh·∫•n n√∫t Create distribution Trong ph·∫ßn t·∫°o distribution, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: Ch·ªçn plan: Free plan Name: Static Dashboard Website CloudFront Origin type: Amazom S3 S3 Origin: Ch·ªçn static-dashboard-bucket Gi·ªØ ph·∫ßn c√≤n l·∫°i nh∆∞ m·∫∑c ƒë·ªãnh B·∫≠t security: S·ª≠ d·ª•ng c√°i n√†y n·∫øu b·∫°n ch·ªçn free plan Xem l·∫°i v√† nh·∫•n Create distribution C√†i ƒë·∫∑t chung (General setting):\nSau khi t·∫°o xong, tr√™n tab General c·ªßa CloudFront nh·∫•n v√†o Edit T·∫°i Default root object nh·∫≠p index.html Description: Static Dashboard Distribution Nh·∫•n Save change T·∫°o API Gateway origin:\nNh·∫•n Origins tr√™n c√°c tab menu Sau ƒë√≥ nh·∫•n Create origin Trong ph·∫ßn t·∫°o origin, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: Origin domain: ch·ªçn dashboard-api Protocol: HTTPS only HTTPS port: 443 Minimum Origin SSL protocol: TLSv1.2 Origin path: /prod Nh·∫•n Create origin T·∫°o behaviors cho API Gateway:\nNh·∫•n Behaviors tr√™n c√°c tab menu Sau ƒë√≥ nh·∫•n Create behavior Trong ph·∫ßn t·∫°o behavior, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: Path pattern: /logs/* Origin v√† origin groups: ch·ªçn dashboard-api ƒê·ªÉ c√°c c√†i ƒë·∫∑t c√≤n l·∫°i nh∆∞ m·∫∑c ƒë·ªãnh Nh·∫•n Create behavior C·∫≠p nh·∫≠t S3 policy ƒë·ªÉ ho·∫°t ƒë·ªông v·ªõi CloudFront:\nNh·∫•n Origins tr√™n c√°c tab menu, ch·ªçn t√™n origin s3-static-dashboard Nh·∫•n Edit T·∫°i ph·∫ßn Origin access controll nh·∫•n Go to S3 bucket permissions Ki·ªÉm tra xem quy·ªÅn S3 c·ªßa b·∫°n c√≥ gi·ªëng th·∫ø n√†y kh√¥ng, n·∫øu kh√¥ng h√£y copy v√† paste n√≥ v√†o quy·ªÅn S3 c·ªßa b·∫°n (Thay ƒë·ªïi ACCOUNT_ID, ACCOUNT_REGION v√† CLOUDFRONT_ID th√†nh c·ªßa b·∫°n): { \u0026#34;Version\u0026#34;: \u0026#34;2008-10-17\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;PolicyForCloudFrontPrivateContent\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;AllowCloudFrontServicePrincipal\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;cloudfront.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;s3:GetObject\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:s3:::s3-static-dashboard-[ACCOUNT_ID]-[ACCOUNT_REGION]/*\u0026#34;, \u0026#34;Condition\u0026#34;: { \u0026#34;ArnLike\u0026#34;: { \u0026#34;AWS:SourceArn\u0026#34;: \u0026#34;arn:aws:cloudfront::[ACCOUNT_ID]:distribution/[CLOUDFRONT_ID]\u0026#34; } } } ] } Nh·∫•n Save change T·∫°o error pages:\nNh·∫•n Error pages tr√™n c√°c tab menu Nh·∫•n Create custom error page Trong ph·∫ßn t·∫°o custom error page, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: HTTP error code: 403: Forbident Error caching minimum TTL: 300 Customize error response: Yes Response page path: /index.html HTTP Response code: 200: OK L·∫∑p l·∫°i b∆∞·ªõc n√†y cho 404 code "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.4-cloudwatch-eni-etl/","title":"M√£ CloudWatch ENI ETL","tags":[],"description":"","content":" import json import boto3 import gzip import os from datetime import datetime s3 = boto3.client(\u0026#34;s3\u0026#34;) firehose = boto3.client(\u0026#34;firehose\u0026#34;) # -------------------------------------------------- # CONFIGURATION # -------------------------------------------------- FIREHOSE_STREAM_NAME = os.environ.get(\u0026#34;FIREHOSE_STREAM_NAME\u0026#34;) # ----------------------------- UTILS ----------------------------- def read_gz(bucket, key): obj = s3.get_object(Bucket=bucket, Key=key) with gzip.GzipFile(fileobj=obj[\u0026#34;Body\u0026#34;]) as f: return f.read().decode(\u0026#34;utf-8\u0026#34;, errors=\u0026#34;replace\u0026#34;) def safe_int(x): try: return int(x) except: return None def parse_flow_log_line(line): parts = line.strip().split(\u0026#39; \u0026#39;) if len(parts) \u0026lt; 14: return None try: start_timestamp = safe_int(parts[10]) time_str = None if start_timestamp: dt_object = datetime.fromtimestamp(start_timestamp) time_str = dt_object.strftime(\u0026#39;%Y-%m-%d %H:%M:%S\u0026#39;) record = { \u0026#34;version\u0026#34;: safe_int(parts[0]), # C·ªôt 1: version (int) \u0026#34;account_id\u0026#34;: parts[1], # C·ªôt 2: account_id (STRING) \u0026#34;interface_id\u0026#34;: parts[2], # C·ªôt 3: eni-... \u0026#34;srcaddr\u0026#34;: parts[3], \u0026#34;dstaddr\u0026#34;: parts[4], \u0026#34;srcport\u0026#34;: safe_int(parts[5]), \u0026#34;dstport\u0026#34;: safe_int(parts[6]), \u0026#34;protocol\u0026#34;: safe_int(parts[7]), \u0026#34;packets\u0026#34;: safe_int(parts[8]), \u0026#34;bytes\u0026#34;: safe_int(parts[9]), \u0026#34;start_time\u0026#34;: start_timestamp, # C·ªôt 11 \u0026#34;end_time\u0026#34;: safe_int(parts[11]), \u0026#34;action\u0026#34;: parts[12], \u0026#34;log_status\u0026#34;: parts[13], \u0026#34;timestamp_str\u0026#34;: time_str } return record except Exception as e: print(f\u0026#34;Error parsing line: {e}\u0026#34;) return None def lambda_handler(event, context): print(f\u0026#34;Received S3 Event. Records: {len(event.get(\u0026#39;Records\u0026#39;, []))}\u0026#34;) firehose_records = [] # Duy·ªát qua c√°c file S3 g·ª≠i v·ªÅ (Iterate through files sent from S3) for record in event.get(\u0026#34;Records\u0026#34;, []): if \u0026#34;s3\u0026#34; not in record: continue bucket = record[\u0026#34;s3\u0026#34;][\u0026#34;bucket\u0026#34;][\u0026#34;name\u0026#34;] key = record[\u0026#34;s3\u0026#34;][\u0026#34;object\u0026#34;][\u0026#34;key\u0026#34;] # Ch·ªâ x·ª≠ l√Ω file .gz (Process .gz files only) if not key.endswith(\u0026#34;.gz\u0026#34;): print(f\u0026#34;Skipping non-gz: {key}\u0026#34;) continue print(f\u0026#34;Processing: {key}\u0026#34;) # ƒê·ªçc n·ªôi dung (Read content) content = read_gz(bucket, key) if not content: continue # Parse t·ª´ng d√≤ng log (Parse each log line) for line in content.splitlines(): rec = parse_flow_log_line(line) if not rec: continue # Chuy·ªÉn th√†nh JSON string v√† th√™m xu·ªëng d√≤ng (\\n) (Convert to JSON string and add newline) json_row = json.dumps(rec) + \u0026#34;\\n\u0026#34; firehose_records.append({\u0026#39;Data\u0026#39;: json_row}) # ƒê·∫©y sang Firehose (Batching 500 d√≤ng) (Push to Firehose - batching 500 lines) if firehose_records: total = len(firehose_records) print(f\u0026#34;Flushing {total} records to Firehose...\u0026#34;) batch_size = 500 for i in range(0, total, batch_size): batch = firehose_records[i:i + batch_size] try: response = firehose.put_record_batch( DeliveryStreamName=FIREHOSE_STREAM_NAME, Records=batch ) if response[\u0026#39;FailedPutCount\u0026#39;] \u0026gt; 0: print(f\u0026#34;Warning: {response[\u0026#39;FailedPutCount\u0026#39;]} records failed.\u0026#34;) except Exception as e: print(f\u0026#34;Firehose API Error: {e}\u0026#34;) return {\u0026#34;status\u0026#34;: \u0026#34;ok\u0026#34;, \u0026#34;count\u0026#34;: len(firehose_records)} "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/4-monitoring-setup/","title":"Thi·∫øt l·∫≠p gi√°m s√°t","tags":[],"description":"","content":"Giai ƒëo·∫°n Thi·∫øt l·∫≠p gi√°m s√°t n√†y k√≠ch ho·∫°t v√† c·∫•u h√¨nh ba ngu·ªìn log c·ªët l√µi ƒë·ªÉ ph√°t hi·ªán m·ªëi ƒëe d·ªça. Giai ƒëo·∫°n n√†y bao g·ªìm vi·ªác b·∫≠t CloudTrail cho c√°c s·ª± ki·ªán qu·∫£n l√Ω v√† d·ªØ li·ªáu to√†n di·ªán, k√≠ch ho·∫°t GuardDuty ƒë·ªÉ xu·∫•t c√°c ph√°t hi·ªán b·∫£o m·∫≠t sang S3 bucket ch√≠nh, v√† thi·∫øt l·∫≠p VPC Flow Logs tr√™n m·∫°ng c·ªßa b·∫°n ƒë·ªÉ g·ª≠i t·∫•t c·∫£ metadata l∆∞u l∆∞·ª£ng truy c·∫≠p ƒë·∫øn CloudWatch Log Group chuy√™n d·ª•ng. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o lu·ªìng d·ªØ li·ªáu log li√™n t·ª•c, t·∫≠p trung lu√¥n s·∫µn s√†ng cho vi·ªác x·ª≠ l√Ω v√† ph·∫£n h·ªìi t·ª± ƒë·ªông.\nT·∫°o CloudWatch Log Group M·ªü CloudWatch Console ‚Üí Log Management ‚Üí Create log group C·∫•u h√¨nh:\nLog group name: /aws/incident-response/centralized-logs Retention: 90 ng√†y KMS key: None Nh·∫•n \u0026ldquo;Create\u0026rdquo;\nB·∫≠t AWS CloudTrail M·ªü CloudTrail Console ‚Üí Trail ‚Üí Create trail Thu·ªôc t√≠nh Trail:\nTrail name: incident-responses-cloudtrail-ACCOUNT_ID-REGION Storage location: S·ª≠ d·ª•ng S3 bucket hi·ªán c√≥ S3 bucket: Ch·ªçn incident-response-log-list-bucket-ACCOUNT_ID-REGION c·ªßa b·∫°n Log file SSE-KMS encryption: Disable (T·∫Øt) Log file validation: Enabled (B·∫≠t) Nh·∫•n next Ch·ªçn log events:\nEvents Ch·ªçn Management events, Data events Management events: T·∫•t c·∫£ (Read + Write) Data events: S3 - Log t·∫•t c·∫£ events Nh·∫•n next ƒë·∫øn b∆∞·ªõc 4 v√† Create Trail Advanced event selectors: Lo·∫°i tr·ª´ log buckets:\nNh·∫•n v√†o Trail sau ƒë√≥ cu·ªôn xu·ªëng Data Event v√† nh·∫•n Edit Thi·∫øt l·∫≠p nh∆∞ h√¨nh v·ªõi ƒë·ªãnh d·∫°ng d∆∞·ªõi ƒë√¢y: -arn:aws:s3:::incident-response-log-list-bucket-ACCOUNT_ID-REGION/\n-arn:aws:s3:::processed-guardduty-findings-ACCOUNT_ID-REGION/\n-arn:aws:s3:::processed-cloudtrail-logs-ACCOUNT_ID-REGION\n-arn:aws:s3:::athena-query-results-ACCOUNT_ID-REGION/\n-arn:aws:s3:::processed-cloudwatch-logs-ACCOUNT_ID-REGION/\nL∆∞u thay ƒë·ªïi B·∫≠t Amazon GuardDuty M·ªü GuardDuty Console ‚Üí Get Started ‚Üí Enable GuardDuty\nC·∫•u h√¨nh c√†i ƒë·∫∑t:\nFinding export frequency: Update CWE v√† S3 m·ªói 15 ph√∫t S3 export: incident-response-log-list-bucket-ACCOUNT_ID-REGION KMS encryption: Ch·ªçn ho·∫∑c t·∫°o KMS key B·∫≠t VPC Flow Logs M·ªü VPC Console ‚Üí Your VPCs ‚Üí Ch·ªçn VPC c·ªßa b·∫°n\nActions ‚Üí Create flow log\nC·∫•u h√¨nh:\nFilter: All (T·∫•t c·∫£) Aggregation interval: 10 ph√∫t Destination: CloudWatch Logs Log group: /aws/incident-response/centralized-logs IAM role: FlowLogsIAMRole Log format: Default (M·∫∑c ƒë·ªãnh) T·∫°o flow log\nB·∫≠t VPC DNS Query Logging C·∫•u h√¨nh Resolver Query Logging M·ªü Amazon Route 53 Console.\n·ªû thanh ƒëi·ªÅu h∆∞·ªõng b√™n tr√°i, ch·ªçn VPC Resolver -\u0026gt; Query logging.\nNh·∫•n \u0026ldquo;Configure query logging\u0026rdquo;.\nC·∫•u h√¨nh:\nName: Nh·∫≠p t√™n m√¥ t·∫£, v√≠ d·ª•: IR-DNS-Query-Log-Config. Destination for query logs: CloudWatch Logs log group Log group: Ch·ªçn \u0026ldquo;Existing log group\u0026rdquo; v√† ch·ªçn: /aws/incident-response/centralized-logs Nh·∫•n \u0026ldquo;Configure query logging\u0026rdquo;.\n"},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/7.5-setup-cognito/","title":"C√†i ƒë·∫∑t Cognito","tags":[],"description":"","content":"Trong h∆∞·ªõng d·∫´n n√†y, b·∫°n s·∫Ω t·∫°o m·ªôt Cognito user pool ƒë·ªÉ ƒëƒÉng nh·∫≠p dashboard.\nT·∫°o Cognito User Pool M·ªü Amazon Cognito Console\nƒêi·ªÅu h∆∞·ªõng t·ªõi https://console.aws.amazon.com/cognito/ Ho·∫∑c: AWS Management Console ‚Üí Services ‚Üí Cognito T·∫°o user pool:\nNh·∫•n Create user pool Trong ph·∫ßn t·∫°o user pool, s·ª≠ d·ª•ng c√†i ƒë·∫∑t n√†y: Application type: Single-page application (SPA) Application name: dashboard-user-pool-client Options for sign-in identifiers: Email v√† Username Self-registration: Enable self-registration Required attributes for sign-up: email Add a return URL: V√†o CloudFront, ch·ªçn c√°i b·∫°n v·ª´a t·∫°o v√† copy Distribution domain name v√† d√°n v√†o ƒë√¢y (V√≠ d·ª•: https://d2bvvvpr6s4eyd.cloudfront.net) Nh·∫•n Create user directory Sau khi t·∫°o, cu·ªôn xu·ªëng v√† nh·∫•n Go to overview C·∫•u h√¨nh User pool App clients:\nCh·ªçn App clients tr√™n menu b√™n tr√°i Ch·ªçn dashboard-user-pool-client Trong ph·∫ßn App client information, nh·∫•n Edit Thay ƒë·ªïi c√†i ƒë·∫∑t nh∆∞ h√¨nh b√™n d∆∞·ªõi: Nh·∫•n Save change C·∫•u h√¨nh Managed login pages:\nTrong ph·∫ßn Managed login pages configuration, nh·∫•n Edit Nh·∫•n Add sign-out URL t·∫°i ph·∫ßn Allowed sign-out URLs Copy URL tr√™n callbacks URL v√† d√°n v√†o Allowed sign-out URLs Cu·ªôn xu·ªëng OpenID Connect scopes th√™m Profile v√†o scopes Nh·∫•n Save change T·∫°o m·ªôt user:\nTr√™n menu b√™n tr√°i, ch·ªçn t√πy ch·ªçn User Nh·∫•n Create user Nh·∫≠p th√¥ng tin ng∆∞·ªùi d√πng c·ªßa b·∫°n Nh·∫•n Create user "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.5-cloudwatch-autoexport/","title":"M√£ CloudWatch Autoexport","tags":[],"description":"","content":" import json import base64 import gzip from io import BytesIO import boto3 import os import time s3 = boto3.client(\u0026#39;s3\u0026#39;) # --- CONFIGURATION (C·∫§U H√åNH) --- RAW_S3_BUCKET = os.environ.get(\u0026#34;DESTINATION_BUCKET\u0026#34;) # The log group pattern constant is no longer used for filtering, but is kept for reference. # VPC_DNS_LOG_PATTERN = \u0026#39;/aws/route53/query/\u0026#39; def is_vpc_dns_log(log_message): try: json_body = json.loads(log_message.strip()) if \u0026#39;query_name\u0026#39; in json_body and \u0026#39;query_type\u0026#39; in json_body: return True return False except Exception: return False def lambda_handler(event, context): try: compressed_payload = base64.b64decode(event[\u0026#39;awslogs\u0026#39;][\u0026#39;data\u0026#39;]) f = BytesIO(compressed_payload) decompressed_data = gzip.GzipFile(fileobj=f).read() log_data = json.loads(decompressed_data.decode(\u0026#39;utf-8\u0026#39;)) log_lines = [] for log_event in log_data.get(\u0026#39;logEvents\u0026#39;, []): log_lines.append(log_event.get(\u0026#39;message\u0026#39;, \u0026#39;\u0026#39;)) if not log_lines: print(f\u0026#34;Batch skipped: No log events found in payload. Log Group: {log_data.get(\u0026#39;logGroup\u0026#39;)}\u0026#34;) return {\u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: \u0026#39;Log batch ignored (No events).\u0026#39;} is_dns_log = is_vpc_dns_log(log_lines[0]) if is_dns_log: key_prefix = \u0026#39;vpc-dns-logs\u0026#39; filename_prefix = \u0026#39;vpc-\u0026#39; # Add vpc- to the filename else: key_prefix = \u0026#39;vpc-flow-logs\u0026#39; filename_prefix = \u0026#39;eni-\u0026#39; # Keep filename blank for other logs output_content = \u0026#39;\\n\u0026#39;.join(log_lines) full_log_group_name = log_data.get(\u0026#39;logGroup\u0026#39;, \u0026#39;unknown-group\u0026#39;) log_group_name_safe = full_log_group_name.strip(\u0026#39;/\u0026#39;).replace(\u0026#39;/\u0026#39;, \u0026#39;_\u0026#39;) final_filename = f\u0026#34;{filename_prefix}{context.aws_request_id}.gz\u0026#34; s3_key = f\u0026#39;exportedlogs/{key_prefix}/{log_group_name_safe}/{final_filename}\u0026#39; buffer = BytesIO() with gzip.GzipFile(fileobj=buffer, mode=\u0026#39;w\u0026#39;) as gz: gz.write(output_content.encode(\u0026#39;utf-8\u0026#39;)) gzipped_data = buffer.getvalue() s3.put_object( Bucket=RAW_S3_BUCKET, Key=s3_key, Body=gzipped_data, ContentType=\u0026#39;application/x-gzip\u0026#39; ) num_logs = len(log_lines) print(f\u0026#34;Exported {num_logs} raw log lines to s3://{RAW_S3_BUCKET}/{s3_key}\u0026#34;) return {\u0026#39;statusCode\u0026#39;: 200, \u0026#39;body\u0026#39;: f\u0026#39;Logs exported. {num_logs} events processed. Key Prefix: {key_prefix}\u0026#39;} except Exception as e: print(f\u0026#34;Error in CW Export Lambda: {e}\u0026#34;) raise e "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/5-processing-setup/","title":"Thi·∫øt l·∫≠p x·ª≠ l√Ω","tags":[],"description":"","content":"Giai ƒëo·∫°n Thi·∫øt l·∫≠p x·ª≠ l√Ω n√†y x√¢y d·ª±ng ƒë∆∞·ªùng ·ªëng d·ªØ li·ªáu (data pipeline) c·ªët l√µi ƒë·ªÉ c·∫•u tr√∫c log th√¥ v√† chu·∫©n b·ªã ch√∫ng cho vi·ªác ph√¢n t√≠ch truy v·∫•n. Giai ƒëo·∫°n n√†y b·∫Øt bu·ªôc tri·ªÉn khai ba lu·ªìng Kinesis Data Firehose ƒë·ªÉ ƒë·ªám v√† ph√¢n ph·ªëi CloudTrail v√† VPC logs ƒë·∫øn c√°c S3 buckets ƒë√≠ch. ƒê·ªìng th·ªùi, b·∫°n s·∫Ω c·∫•u h√¨nh AWS Glue Database v√† b·ªën b·∫£ng Athena th√¥ng qua DDL ƒë·ªÉ l√†m cho d·ªØ li·ªáu c√≥ c·∫•u tr√∫c c√≥ th·ªÉ truy v·∫•n ƒë∆∞·ª£c. Pipeline n√†y d·ª±a v√†o nƒÉm Lambda functions ETL ƒë∆∞·ª£c k√≠ch ho·∫°t b·ªüi S3 Event Notifications ƒë·ªÉ th·ª±c hi·ªán chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu c·∫ßn thi·∫øt khi log ƒë·∫øn.\nN·ªôi dung T·∫°o Kinesis Data Firehose Delivery Streams T·∫°o AWS Glue Database v√† Tables T·∫°o Lambda Functions - X·ª≠ l√Ω ETL "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/","title":"Workshop","tags":[],"description":"","content":"Thi·∫øt l·∫≠p h·ªá th·ªëng ph·∫£n h·ªìi s·ª± c·ªë t·ª± ƒë·ªông v√† ph√°p y s·ªë tr√™n AWS T·ªïng quan H∆∞·ªõng d·∫´n n√†y cung c·∫•p quy tr√¨nh t·ª´ng b∆∞·ªõc ho√†n ch·ªânh ƒë·ªÉ tri·ªÉn khai h·ªá th·ªëng ph·∫£n h·ªìi s·ª± c·ªë v√† ƒëi·ªÅu tra s·ªë (forensics) t·ª± ƒë·ªông c·ªßa ch√∫ng t√¥i tr√™n AWS. H·ªá th·ªëng n√†y t·∫≠n d·ª•ng CloudTrail, GuardDuty, VPC Flow Logs, Kinesis Firehose, Glue, Athena, v√† Lambda functions ƒë∆∞·ª£c ƒëi·ªÅu ph·ªëi b·ªüi AWS Step Functions ƒë·ªÉ t·ª± ƒë·ªông ph√°t hi·ªán, ph√¢n t√≠ch v√† c√°ch ly c√°c t√†i nguy√™n b·ªã x√¢m ph·∫°m nh∆∞ EC2 instances v√† IAM users. Kh·∫£ nƒÉng ƒëi·ªÅu tra log s√¢u h∆°n ƒë∆∞·ª£c b·ªï sung b·∫±ng c√°ch thi·∫øt l·∫≠p Security Dashboard l∆∞u tr·ªØ tr√™n S3 v√† truy c·∫≠p qua CloudFront v√† Cognito, truy v·∫•n log s·ª≠ d·ª•ng API Gateway v√† Lambda.\nN·ªôi dung T·ªïng quan ƒêi·ªÅu ki·ªán ti√™n quy·∫øt Giai ƒëo·∫°n 1: Thi·∫øt l·∫≠p n·ªÅn t·∫£ng Giai ƒëo·∫°n 2: Thi·∫øt l·∫≠p gi√°m s√°t Giai ƒëo·∫°n 3: Thi·∫øt l·∫≠p x·ª≠ l√Ω Giai ƒëo·∫°n 4: Thi·∫øt l·∫≠p t·ª± ƒë·ªông h√≥a Giai ƒëo·∫°n 5: Thi·∫øt l·∫≠p Dashboard Ki·ªÉm tra S·ª≠ d·ª•ng CDK D·ªçn d·∫πp Ph·ª• l·ª•c "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.6-parse-findings/","title":"M√£ Parse Findings","tags":[],"description":"","content":" import json import logging logger = logging.getLogger() logger.setLevel(logging.INFO) def lambda_handler(event, context): instance_ids = [] detail = event.get(\u0026#39;detail\u0026#39;, {}) region = event.get(\u0026#39;region\u0026#39;) or detail.get(\u0026#39;region\u0026#39;) or \u0026#39;ap-southeast-1\u0026#39; instance_id_primary = detail.get(\u0026#39;resource\u0026#39;, {}).get(\u0026#39;instanceDetails\u0026#39;, {}).get(\u0026#39;instanceId\u0026#39;) if instance_id_primary: instance_ids.append(instance_id_primary) # --- 2. Extract from the older/secondary \u0026#39;resources\u0026#39; array structure --- # --- 2. Tr√≠ch xu·∫•t t·ª´ c·∫•u tr√∫c m·∫£ng \u0026#39;resources\u0026#39; c≈©/ph·ª• --- for r in detail.get(\u0026#34;resources\u0026#34;, []): if r.get(\u0026#34;type\u0026#34;) == \u0026#34;AwsEc2Instance\u0026#34;: id_from_details = r.get(\u0026#39;details\u0026#39;, {}).get(\u0026#39;instanceId\u0026#39;) if id_from_details: instance_ids.append(id_from_details) else: arn_id = r.get(\u0026#39;id\u0026#39;) if arn_id and arn_id.startswith(\u0026#39;arn:aws:ec2:\u0026#39;): instance_ids.append(arn_id.split(\u0026#39;/\u0026#39;)[-1]) unique_instance_ids = list(set([id for id in instance_ids if id])) return { \u0026#34;InstanceIds\u0026#34;: unique_instance_ids, \u0026#34;Region\u0026#34;: region } "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/6-automation-setup/","title":"Thi·∫øt l·∫≠p t·ª± ƒë·ªông h√≥a","tags":[],"description":"","content":"Giai ƒëo·∫°n 4: Thi·∫øt l·∫≠p t·ª± ƒë·ªông h√≥a T·∫°o Isolation Security Group EC2 Console ‚Üí Security Groups ‚Üí Create security group Name: IR-Isolation-SG Description: Denies all inbound and outbound traffic for compromised instances (Ch·∫∑n t·∫•t c·∫£ l∆∞u l∆∞·ª£ng ƒëi v√† ƒë·∫øn cho c√°c instance b·ªã x√¢m ph·∫°m) VPC: Ch·ªçn VPC c·ªßa b·∫°n Inbound rules: Kh√¥ng c√≥ (t·ª´ ch·ªëi t·∫•t c·∫£ - deny all) Outbound rules: X√≥a m·∫∑c ƒë·ªãnh (t·ª´ ch·ªëi t·∫•t c·∫£ - deny all) T·∫°o v√† ghi l·∫°i Security Group ID (v√≠ d·ª•: sg-0078026b70389e7b3) T·∫°o SNS Topic SNS Console ‚Üí Create topic Type: Standard, Name: IncidentResponseAlerts Access policy: { \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;0\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;events.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;sns:Publish\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:sns:ap-southeast-1:831981618496:IncidentResponseAlerts\u0026#34; }, { \u0026#34;Sid\u0026#34;: \u0026#34;AWSEvents_IncidentResponseAlert_Target0\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: { \u0026#34;Service\u0026#34;: \u0026#34;events.amazonaws.com\u0026#34; }, \u0026#34;Action\u0026#34;: \u0026#34;SNS:Publish\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:sns:ap-southeast-1:831981618496:IncidentResponseAlerts\u0026#34; } ] } T·∫°o Lambda Functions - Ph·∫£n h·ªìi s·ª± c·ªë (Incident Response) ir-parse-findings-lambda Handler: parse_findings.lambda_handler Role: ParseFindingsLambdaServiceRole Code: parse-findings ir-isolate-ec2-lambda Handler: isolate_ec2.lambda_handler Role: IsolateEC2LambdaServiceRole Env: ISOLATION_SG_ID=sg-XXXXXXX (t·ª´ b∆∞·ªõc 12) Code: isolate-ec2 ir-quarantine-iam-lambda Handler: quarantine_iam.lambda_handler Role: QuarantineIAMLambdaServiceRole Env: QUARANTINE_POLICY_ARN=arn:aws:iam::ACCOUNT_ID:policy/IrQuarantineIAMPolicy Code: quarantine-iam ir-alert-dispatch Handler: alert_dispatch.lambda_handler Role: AlertDispatchLambdaServiceRole Env: SENDER_EMAIL, RECIPIENT_EMAIL, SLACK_WEBHOOK_URL Add SNS trigger: Topic IncidentResponseAlerts Code: alert-dispatch C·∫≠p nh·∫≠t SNS Topic Subscription SNS Console ‚Üí IncidentResponseAlerts ‚Üí Subscriptions X√°c minh: Protocol=AWS Lambda, Endpoint=ir-alert-dispatch, Status=Confirmed T·∫°o Step Functions State Machine Step Functions Console ‚Üí Create state machine Type: Standard, Name: IncidentResponseStepFunctions Definition: Step Functions Definition Role: StepFunctionsRole Create T·∫°o EventBridge Rule EventBridge Console ‚Üí Rules ‚Üí Create rule Name: IncidentResponseAlert Event pattern: { \u0026#34;source\u0026#34;: [\u0026#34;aws.guardduty\u0026#34;], \u0026#34;detail-type\u0026#34;: [\u0026#34;GuardDuty Finding\u0026#34;] } Targets (2): SNS topic: IncidentResponseAlerts Step Functions: IncidentResponseStepFunctions v·ªõi role IncidentResponseStepFunctionsEventRole C·∫•u h√¨nh Athena Workgroup Athena Console ‚Üí Workgroups ‚Üí primary ‚Üí Edit Query result location: s3://athena-query-results-ACCOUNT_ID-REGION/ L∆∞u (Save) "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.7-isolate-ec2/","title":"M√£ Isolate EC2","tags":[],"description":"","content":" import json import boto3 import os from botocore.exceptions import ClientError ISOLATION_SG_ID = os.getenv(\u0026#39;ISOLATION_SG_ID\u0026#39;) def lambda_handler(event, context): print(\u0026#34;=== ISOLATE EVENT RECEIVED ===\u0026#34;) print(json.dumps(event, indent=2)) instance_id = event.get(\u0026#39;InstanceId\u0026#39;) region = event.get(\u0026#39;Region\u0026#39;, \u0026#39;ap-southeast-1\u0026#39;) if not instance_id or not ISOLATION_SG_ID: print(\u0026#34;[ERROR] Missing InstanceId or IsolationSGId in input. Cannot isolate.\u0026#34;) return {\u0026#34;status\u0026#34;: \u0026#34;isolation_failed\u0026#34;, \u0026#34;InstanceId\u0026#34;: instance_id, \u0026#34;error\u0026#34;: \u0026#34;Missing input data\u0026#34;} try: ec2 = boto3.client(\u0026#39;ec2\u0026#39;, region_name=region) response = ec2.describe_instances(InstanceIds=[instance_id]) instance = response[\u0026#39;Reservations\u0026#39;][0][\u0026#39;Instances\u0026#39;][0] current_sgs = [sg[\u0026#39;GroupId\u0026#39;] for sg in instance.get(\u0026#39;SecurityGroups\u0026#39;, [])] if ISOLATION_SG_ID in current_sgs: print(f\u0026#34;[INFO] {instance_id} already has isolation SG {ISOLATION_SG_ID}\u0026#34;) return { **event, \u0026#34;status\u0026#34;: \u0026#34;already_isolated\u0026#34;, \u0026#34;InstanceId\u0026#34;: instance_id, \u0026#34;Region\u0026#34;: region, \u0026#34;IsolationSG\u0026#34;: None } print(f\u0026#34;[ACTION] Isolating {instance_id} in {region} with SG {ISOLATION_SG_ID}\u0026#34;) ec2.modify_instance_attribute( InstanceId=instance_id, Groups=[ISOLATION_SG_ID] ) print(f\u0026#34;[SUCCESS] {instance_id} isolated with SG {ISOLATION_SG_ID}\u0026#34;) return { **event, \u0026#34;status\u0026#34;: \u0026#34;isolation_complete\u0026#34;, \u0026#34;InstanceId\u0026#34;: instance_id, \u0026#34;Region\u0026#34;: region, \u0026#34;IsolationSG\u0026#34;: ISOLATION_SG_ID } except ClientError as e: error_code = e.response.get(\u0026#39;Error\u0026#39;, {}).get(\u0026#39;Code\u0026#39;) print(f\u0026#34;[ERROR] Isolation FAILED for {instance_id} ({error_code}): {str(e)}\u0026#34;) return { \u0026#34;status\u0026#34;: \u0026#34;isolation_failed\u0026#34;, \u0026#34;InstanceId\u0026#34;: instance_id, \u0026#34;error\u0026#34;: str(e) } except Exception as e: print(f\u0026#34;[ERROR] Isolation FAILED (General) for {instance_id}: {str(e)}\u0026#34;) raise e "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/7-dashboard-setup/","title":"Thi·∫øt l·∫≠p Dashboard","tags":[],"description":"","content":"H∆∞·ªõng d·∫´n n√†y s·∫Ω ch·ªâ cho b·∫°n c√°ch thi·∫øt l·∫≠p security dashboard. Security dashboard s·∫Ω s·ª≠ d·ª•ng S3 ƒë·ªÉ ch·ª©a c√°c file v√† th∆∞ m·ª•c web, Lambda ƒë·ªÉ truy v·∫•n d·ªØ li·ªáu b·∫±ng Athena, API Gateway ƒë·ªÉ ƒë·ªãnh tuy·∫øn api t·ªõi Lambda v√† CloudFront ƒë·ªÉ caching v√† truy c·∫≠p web b·∫±ng URL c·ªßa n√≥.\nN·ªôi dung Thi·∫øt l·∫≠p S3 Thi·∫øt l·∫≠p Lambda Thi·∫øt l·∫≠p API Gateway Thi·∫øt l·∫≠p CloudFront Thi·∫øt l·∫≠p Cognito "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/8-verify-setup/","title":"Ki·ªÉm tra thi·∫øt l·∫≠p","tags":[],"description":"","content":"Sau t·∫•t c·∫£ c√°c giai ƒëo·∫°n thi·∫øt l·∫≠p, vui l√≤ng tham kh·∫£o checklist ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác t·∫°o t√†i nguy√™n ƒë√£ ho√†n t·∫•t.\nX√°c minh thi·∫øt l·∫≠p Checklist x√°c minh ho√†n th√†nh:\nIncident Response and Forensics:\n‚úÖ S3 Buckets: T·∫•t c·∫£ 5 buckets ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi versioning/encryption ‚úÖ IAM Roles: T·∫•t c·∫£ 17 roles v·ªõi ƒë√∫ng policies ‚úÖ CloudTrail: Logging ƒë√£ ƒë∆∞·ª£c b·∫≠t ‚úÖ GuardDuty: ƒê√£ b·∫≠t v·ªõi S3 export ‚úÖ VPC Flow Logs: ƒêang ho·∫°t ƒë·ªông (Active) ‚úÖ Lambda Functions: T·∫•t c·∫£ 9 functions ƒë√£ deploy ‚úÖ Firehose Streams: T·∫•t c·∫£ 3 streams ƒëang ho·∫°t ƒë·ªông ‚úÖ Glue Tables: T·∫•t c·∫£ 4 tables ƒë√£ ƒë∆∞·ª£c t·∫°o ‚úÖ S3 Events: T·∫•t c·∫£ 4 triggers ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ‚úÖ SNS Topic: ƒê√£ t·∫°o v·ªõi subscription ‚úÖ Step Functions: ƒêang ho·∫°t ƒë·ªông (Active) ‚úÖ EventBridge Rule: ƒê√£ b·∫≠t v·ªõi 2 targets Security Dashboard:\n‚úÖ S3 Buckets: Bucket ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi file dashboard ƒë∆∞·ª£c l∆∞u tr·ªØ v√† b·∫≠t hosting ‚úÖ Query Lambda: Lambda ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi c√°c roles th√≠ch h·ª£p ‚úÖ API Gateway: API Gateway ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi ƒë√∫ng API v√† t√†i nguy√™n ‚úÖ CloudFront: Distribution ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi API v√† S3 origins ƒë√£ c·∫•u h√¨nh ‚úÖ Cognito: ƒê√£ li√™n k·∫øt v·ªõi CloudFront distribution v√† t·∫°o user trong user pool Ki·ªÉm tra ƒë·∫ßu cu·ªëi (End-to-End Test)\nT·∫°o m·∫´u c√°c ph√°t hi·ªán GuardDuty: 1.1 GuardDuty Console ‚Üí Settings ‚Üí Generate sample findings (200+ findings) ho·∫∑c 1.2 K√≠ch ho·∫°t m·ªôt finding ƒë∆°n l·∫ª qua CloudShell (Detector Id n·∫±m trong GuardDuty Console ‚Üí Settings ) aws guardduty create-sample-findings --detector-id [$dectector-id] --finding-types \u0026#34;Recon:EC2/PortProbeUnprotectedPort\u0026#34; Gi√°m s√°t workflow: Ki·ªÉm tra EventBridge, SNS, Step Functions, Lambda logs X√°c minh c·∫£nh b√°o: Ki·ªÉm tra email v√† Slack Truy v·∫•n d·ªØ li·ªáu trong Athena: "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.8-quarantine-iam/","title":"M√£ Quarantine IAM","tags":[],"description":"","content":" import json import boto3 import os QUARANTINE_POLICY_ARN = os.environ.get(\u0026#34;QUARANTINE_POLICY_ARN\u0026#34;) def lambda_handler(event, context): print(\u0026#34;=== EVENT RECEIVED ===\u0026#34;) print(json.dumps(event, indent=2)) try: finding = event.get(\u0026#39;detail\u0026#39;, {}) user_name = ( finding.get(\u0026#39;resource\u0026#39;, {}) .get(\u0026#39;accessKeyDetails\u0026#39;, {}) .get(\u0026#39;userName\u0026#39;) ) if not user_name: print(\u0026#34;[WARNING] No IAM user found in this finding. Skipping.\u0026#34;) return {\u0026#34;status\u0026#34;: \u0026#34;no_user\u0026#34;} print(f\u0026#34;[ACTION] Quarantining IAM User \u0026#39;{user_name}\u0026#39;...\u0026#34;) iam = boto3.client(\u0026#39;iam\u0026#39;) # Ki·ªÉm tra n·∫øu policy ƒë√£ ƒë∆∞·ª£c g√°n (Check if policy is already attached) attached_policies = iam.list_attached_user_policies(UserName=user_name)[\u0026#39;AttachedPolicies\u0026#39;] policy_arns = [p[\u0026#39;PolicyArn\u0026#39;] for p in attached_policies] if QUARANTINE_POLICY_ARN in policy_arns: print(f\u0026#34;[INFO] Policy {QUARANTINE_POLICY_ARN} is already attached to user {user_name}.\u0026#34;) else: iam.attach_user_policy( UserName=user_name, PolicyArn=QUARANTINE_POLICY_ARN ) print(f\u0026#34;[SUCCESS] Policy attached. User {user_name} is now quarantined.\u0026#34;) except Exception as e: print(f\u0026#34;[ERROR] Failed to quarantine user: {str(e)}\u0026#34;) raise e return {\u0026#34;status\u0026#34;: \u0026#34;processed\u0026#34;, \u0026#34;action\u0026#34;: \u0026#34;iam_quarantined\u0026#34;} "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.9-alert-dispatch/","title":"M√£ Alert Dispatch","tags":[],"description":"","content":" import os import json import logging import urllib.request import boto3 from botocore.exceptions import ClientError import html # --- Telegram ENV --- # BOT_TOKEN = os.environ.get(\u0026#39;BOT_TOKEN\u0026#39;) # CHAT_ID = os.environ.get(\u0026#39;CHAT_ID\u0026#39;) # MESSAGE_THREAD_ID = os.environ.get(\u0026#39;MESSAGE_THREAD_ID\u0026#39;) # --- Slack ENV --- SLACK_WEBHOOK_URL = os.environ.get(\u0026#34;SLACK_WEBHOOK_URL\u0026#34;) # --- SES ENV --- SENDER_EMAIL = os.environ.get(\u0026#39;SENDER_EMAIL\u0026#39;) RECIPIENT_EMAIL = os.environ.get(\u0026#39;RECIPIENT_EMAIL\u0026#39;) # Can now be \u0026#34;a@b.com, c@d.com\u0026#34; AWS_REGION = os.environ.get(\u0026#39;AWS_REGION\u0026#39;, \u0026#39;ap-southeast-1\u0026#39;) # --- Setup --- # TELEGRAM_URL = f\u0026#34;https://api.telegram.org/bot{BOT_TOKEN}/sendMessage\u0026#34; if BOT_TOKEN else None logger = logging.getLogger() logger.setLevel(logging.INFO) # Initialize SES Client ses_client = boto3.client(\u0026#39;ses\u0026#39;, region_name=AWS_REGION) # ==================================================================== # SEND TO TELEGRAM # ==================================================================== # def send_to_telegram(finding, chat_id, thread_id): # logger.info(\u0026#34;Formatting message for Telegram...\u0026#34;) # ... (Code commented out, keeping as is or translating if needed, but it is commented out so skipping detailed translation for brevity unless enabled) # ==================================================================== # SEND TO SLACK # ==================================================================== def send_to_slack(finding): if not SLACK_WEBHOOK_URL: logger.warning(\u0026#34;Slack ENV missing. Skipping.\u0026#34;) return severity_num = finding.get(\u0026#34;severity\u0026#34;, 0) title = finding.get(\u0026#34;title\u0026#34;, \u0026#34;No Title\u0026#34;) description = finding.get(\u0026#34;description\u0026#34;, \u0026#34;No Description\u0026#34;) region = finding.get(\u0026#34;region\u0026#34;, \u0026#34;N/A\u0026#34;) account_id = finding.get(\u0026#34;accountId\u0026#34;, \u0026#34;N/A\u0026#34;) finding_type = finding.get(\u0026#34;type\u0026#34;, \u0026#34;N/A\u0026#34;) if severity_num \u0026gt;= 7: color = \u0026#34;#ff0000\u0026#34; sev = \u0026#34;üî¥ CAO (HIGH)\u0026#34; elif severity_num \u0026gt;= 4: color = \u0026#34;#ffa500\u0026#34; sev = \u0026#34;üü† TRUNG B√åNH (MEDIUM)\u0026#34; else: color = \u0026#34;#007bff\u0026#34; sev = \u0026#34;üîµ TH·∫§P (LOW)\u0026#34; payload = { \u0026#34;text\u0026#34;: f\u0026#34;üö® {sev} ‚Äì {title}\u0026#34;, \u0026#34;attachments\u0026#34;: [{ \u0026#34;color\u0026#34;: color, \u0026#34;blocks\u0026#34;: [ {\u0026#34;type\u0026#34;: \u0026#34;header\u0026#34;, \u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;plain_text\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;üö® GuardDuty Finding: {title}\u0026#34;}}, {\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;, \u0026#34;fields\u0026#34;: [ {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;*M·ª©c ƒë·ªô (Severity):*\\n{sev}\u0026#34;}, {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;*Khu v·ª±c (Region):*\\n{region}\u0026#34;} ]}, {\u0026#34;type\u0026#34;: \u0026#34;section\u0026#34;, \u0026#34;text\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;*M√¥ t·∫£ (Description):*\\n{description}\u0026#34;}}, {\u0026#34;type\u0026#34;: \u0026#34;divider\u0026#34;}, {\u0026#34;type\u0026#34;: \u0026#34;context\u0026#34;, \u0026#34;elements\u0026#34;: [ {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;*T√†i kho·∫£n (Account):* `{account_id}`\u0026#34;}, {\u0026#34;type\u0026#34;: \u0026#34;mrkdwn\u0026#34;, \u0026#34;text\u0026#34;: f\u0026#34;*Lo·∫°i (Type):* `{finding_type}`\u0026#34;} ]} ] }] } try: req = urllib.request.Request( SLACK_WEBHOOK_URL, data=json.dumps(payload).encode(\u0026#34;utf-8\u0026#34;), headers={\u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;} ) with urllib.request.urlopen(req) as response: logger.info(\u0026#34;Slack response: \u0026#34; + response.read().decode(\u0026#34;utf-8\u0026#34;)) except Exception as e: logger.error(f\u0026#34;SLACK FAILED: {e}\u0026#34;) # ==================================================================== # SEND TO SES EMAIL (UPDATED FOR MULTIPLE RECIPIENTS) # ==================================================================== def send_to_ses(finding): if not SENDER_EMAIL or not RECIPIENT_EMAIL: logger.warning(\u0026#34;SES Env vars missing. Skipping Email.\u0026#34;) return logger.info(\u0026#34;Formatting message for SES Email...\u0026#34;) recipient_list = [email.strip() for email in RECIPIENT_EMAIL.split(\u0026#39;,\u0026#39;)] severity_num = finding.get(\u0026#34;severity\u0026#34;, 0) title = finding.get(\u0026#34;title\u0026#34;, \u0026#34;No Title\u0026#34;) description = finding.get(\u0026#34;description\u0026#34;, \u0026#34;No Description\u0026#34;) region = finding.get(\u0026#34;region\u0026#34;, \u0026#34;N/A\u0026#34;) account_id = finding.get(\u0026#34;accountId\u0026#34;, \u0026#34;N/A\u0026#34;) finding_type = finding.get(\u0026#34;type\u0026#34;, \u0026#34;N/A\u0026#34;) finding_id = finding.get(\u0026#34;id\u0026#34;, \u0026#34;N/A\u0026#34;) if severity_num \u0026gt;= 7: color = \u0026#34;#ff0000\u0026#34; sev = \u0026#34;HIGH (CAO)\u0026#34; elif severity_num \u0026gt;= 4: color = \u0026#34;#ffa500\u0026#34; sev = \u0026#34;MEDIUM (TRUNG B√åNH)\u0026#34; else: color = \u0026#34;#007bff\u0026#34; sev = \u0026#34;LOW (TH·∫§P)\u0026#34; html_body = f\u0026#34;\u0026#34;\u0026#34; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;style\u0026gt; body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }} .container {{ width: 100%; max-width: 600px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }} .header {{ background-color: {color}; color: white; padding: 15px; text-align: center; }} .content {{ padding: 20px; }} .footer {{ background-color: #f4f4f4; padding: 10px; text-align: center; font-size: 12px; color: #666; }} .label {{ font-weight: bold; color: #555; }} \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;header\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;üö® C·∫£nh b√°o GuardDuty: {sev}\u0026lt;/h2\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;{title}\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;{description}\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ID T√†i kho·∫£n:\u0026lt;/span\u0026gt; {account_id}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;Khu v·ª±c:\u0026lt;/span\u0026gt; {region}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;Lo·∫°i:\u0026lt;/span\u0026gt; {finding_type}\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;span class=\u0026#34;label\u0026#34;\u0026gt;ID Ph√°t hi·ªán:\u0026lt;/span\u0026gt; {finding_id}\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;footer\u0026#34;\u0026gt; ƒê∆∞·ª£c t·∫°o b·ªüi AWS Lambda Alert Dispatch \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026#34;\u0026#34;\u0026#34; try: response = ses_client.send_email( Source=SENDER_EMAIL, Destination={\u0026#39;ToAddresses\u0026#39;: recipient_list}, # Uses the list now Message={ \u0026#39;Subject\u0026#39;: {\u0026#39;Data\u0026#39;: f\u0026#34;GuardDuty Alert [{sev}]: {title}\u0026#34;, \u0026#39;Charset\u0026#39;: \u0026#39;UTF-8\u0026#39;}, \u0026#39;Body\u0026#39;: {\u0026#39;Html\u0026#39;: {\u0026#39;Data\u0026#39;: html_body, \u0026#39;Charset\u0026#39;: \u0026#39;UTF-8\u0026#39;}} } ) logger.info(f\u0026#34;SES Email sent to {len(recipient_list)} recipients! MessageId: {response[\u0026#39;MessageId\u0026#39;]}\u0026#34;) except ClientError as e: logger.error(f\u0026#34;SES FAILED: {e.response[\u0026#39;Error\u0026#39;][\u0026#39;Message\u0026#39;]}\u0026#34;) # ==================================================================== # MAIN HANDLER # ==================================================================== def lambda_handler(event, context): logger.info(f\u0026#34;Event received: {json.dumps(event)}\u0026#34;) try: sns_message_raw = event[\u0026#34;Records\u0026#34;][0][\u0026#34;Sns\u0026#34;][\u0026#34;Message\u0026#34;] message_data = json.loads(sns_message_raw) # Normalization Logic finding = {} if \u0026#34;detail-type\u0026#34; in message_data and message_data[\u0026#34;detail-type\u0026#34;] == \u0026#34;GuardDuty Finding\u0026#34;: detail = message_data[\u0026#34;detail\u0026#34;] finding = { \u0026#34;severity\u0026#34;: detail.get(\u0026#34;severity\u0026#34;, 0), \u0026#34;title\u0026#34;: detail.get(\u0026#34;title\u0026#34;, \u0026#34;GuardDuty Finding\u0026#34;), \u0026#34;description\u0026#34;: detail.get(\u0026#34;description\u0026#34;, \u0026#34;No description provided\u0026#34;), \u0026#34;accountId\u0026#34;: detail.get(\u0026#34;accountId\u0026#34;, \u0026#34;N/A\u0026#34;), \u0026#34;region\u0026#34;: detail.get(\u0026#34;region\u0026#34;, \u0026#34;N/A\u0026#34;), \u0026#34;type\u0026#34;: detail.get(\u0026#34;type\u0026#34;, \u0026#34;N/A\u0026#34;), \u0026#34;id\u0026#34;: detail.get(\u0026#34;id\u0026#34;, \u0026#34;N/A\u0026#34;) } elif \u0026#34;AlarmName\u0026#34; in message_data: state = message_data.get(\u0026#34;NewStateValue\u0026#34;) severity = 8 if state == \u0026#34;ALARM\u0026#34; else 0 finding = { \u0026#34;severity\u0026#34;: severity, \u0026#34;title\u0026#34;: f\u0026#34;CloudWatch Alarm: {message_data.get(\u0026#39;AlarmName\u0026#39;)}\u0026#34;, \u0026#34;description\u0026#34;: message_data.get(\u0026#34;NewStateReason\u0026#34;, \u0026#34;State change detected\u0026#34;), \u0026#34;accountId\u0026#34;: message_data.get(\u0026#34;AWSAccountId\u0026#34;, \u0026#34;N/A\u0026#34;), \u0026#34;region\u0026#34;: message_data.get(\u0026#34;Region\u0026#34;, \u0026#34;N/A\u0026#34;), \u0026#34;type\u0026#34;: \u0026#34;CloudWatch Alarm\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;N/A\u0026#34; } else: finding = { \u0026#34;severity\u0026#34;: 0, \u0026#34;title\u0026#34;: \u0026#34;Unknown Alert\u0026#34;, \u0026#34;description\u0026#34;: f\u0026#34;Raw Payload: {json.dumps(message_data)}\u0026#34;, \u0026#34;accountId\u0026#34;: \u0026#34;N/A\u0026#34;, \u0026#34;region\u0026#34;: \u0026#34;N/A\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;Unknown\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;N/A\u0026#34; } except Exception as e: logger.error(f\u0026#34;FATAL: Could not parse incoming SNS event: {e}\u0026#34;) return {\u0026#34;statusCode\u0026#34;: 500} # --- Send Telegram --- # if BOT_TOKEN and CHAT_ID: # send_to_telegram(finding, CHAT_ID, MESSAGE_THREAD_ID) # --- Send Slack --- if SLACK_WEBHOOK_URL: send_to_slack(finding) # --- Send SES Email --- if SENDER_EMAIL and RECIPIENT_EMAIL: send_to_ses(finding) return {\u0026#34;statusCode\u0026#34;: 200, \u0026#34;body\u0026#34;: \u0026#34;Dispatch complete\u0026#34;} "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/9-use-cdk/","title":"S·ª≠ d·ª•ng CDK","tags":[],"description":"","content":"T·ªïng quan Ch√∫ng t√¥i ƒë√£ cung c·∫•p CDK stack ƒë·ªÉ t·∫°o to√†n b·ªô c∆° s·ªü h·∫° t·∫ßng c·∫ßn thi·∫øt cho workshop n√†y.\nƒê·ªÉ l·∫•y c√°c file, vui l√≤ng truy c·∫≠p Github Link v√† clone ho·∫∑c t·∫£i xu·ªëng t·∫•t c·∫£ c√°c file v·ªÅ m·ªôt th∆∞ m·ª•c.\nH∆∞·ªõng d·∫´n c√†i ƒë·∫∑t Tr∆∞·ªõc khi tri·ªÉn khai CDK stack, b·∫°n ph·∫£i c·∫•u h√¨nh m√¥i tr∆∞·ªùng c·ª•c b·ªô c·ªßa m√¨nh ƒë·ªÉ x√°c th·ª±c v·ªõi t√†i kho·∫£n AWS b·∫±ng AWS Command Line Interface (CLI).\nC√†i ƒë·∫∑t AWS CLI.\nL·∫•y Credentials: B·∫°n c·∫ßn m·ªôt Access Key ID v√† m·ªôt Secret Access Key t·ª´ m·ªôt IAM user c√≥ quy·ªÅn deployment.\nCh·∫°y l·ªánh c·∫•u h√¨nh: M·ªü terminal v√† ch·∫°y l·ªánh aws configure.\n$ aws configure Khi ƒë∆∞·ª£c nh·∫Øc, nh·∫≠p credentials v√† c√°c c√†i ƒë·∫∑t mong mu·ªën. Default region name n√™n kh·ªõp v·ªõi region n∆°i b·∫°n ƒë·ªãnh tri·ªÉn khai stack (v√≠ d·ª•: ap-southeast-1):\nPrompt Example Value AWS Access Key ID AKIA... AWS Secret Access Key wJalr... Default region name ap-southeast-1 Default output format json X√°c minh c·∫•u h√¨nh: Ki·ªÉm tra thi·∫øt l·∫≠p b·∫±ng c√°ch l·∫•y user identity. K·∫øt qu·∫£ th√†nh c√¥ng x√°c nh·∫≠n b·∫°n ƒë√£ x√°c th·ª±c.\n$ aws sts get-caller-identity ƒêi·ªÅu ki·ªán ti√™n quy·∫øt ƒê·∫£m b·∫£o c√°c c√¥ng c·ª• v√† d·ªãch v·ª• sau ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t v√† c·∫•u h√¨nh tr√™n h·ªá th·ªëng c·ªßa b·∫°n:\nPython 3.8+ v√† pip: C·∫ßn thi·∫øt ƒë·ªÉ th·ª±c thi ·ª©ng d·ª•ng CDK v√† build Lambda function assets. Node.js v√† npm: C·∫ßn thi·∫øt ƒë·ªÉ ch·∫°y AWS CDK CLI v√† build React dashboard. AWS CDK Toolkit: C√†i ƒë·∫∑t CDK CLI global: $ npm install -g aws-cdk Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng Python ƒê·ªãnh nghƒ©a c∆° s·ªü h·∫° t·∫ßng ƒë∆∞·ª£c vi·∫øt b·∫±ng Python. M·ªôt virtual environment chuy√™n d·ª•ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ qu·∫£n l√Ω c√°c dependencies c·ªßa d·ª± √°n.\nT·∫°o Virtual Environment:\n$ python -m venv .venv K√≠ch ho·∫°t Virtual Environment:\nOperating System Command macOS / Linux source .venv/bin/activate Windows (Command Prompt) .venv\\Scripts\\activate.bat Windows (PowerShell) .venv\\Scripts\\Activate.ps1 C√†i ƒë·∫∑t Python Dependencies:\n$ pip install -r requirements.txt B∆∞·ªõc build dashboard T·∫°i v·ªã tr√≠ th∆∞ m·ª•c d·ª± √°n, ki·ªÉm tra b√™n trong th∆∞ m·ª•c react. N·∫øu th∆∞ m·ª•c dist ƒë√£ t·ªìn t·∫°i, b·∫°n kh√¥ng c·∫ßn ph·∫£i build. N·∫øu ch∆∞a, vui l√≤ng l√†m theo c√°c b∆∞·ªõc d∆∞·ªõi ƒë√¢y. N·∫øu b·∫°n ƒëang d√πng cmd s·ª≠ d·ª•ng l·ªánh n√†y ƒë·ªÉ di chuy·ªÉn v√†o th∆∞ m·ª•c react:\n$ cd react V√† s·ª≠ d·ª•ng l·ªánh n√†y ƒë·ªÉ li·ªát k√™ t·∫•t c·∫£ n·ªôi dung trong react:\n$ ls ƒêi·ªÅu ki·ªán ti√™n quy·∫øt ƒê·∫£m b·∫£o b·∫°n ƒë√£ c√†i ƒë·∫∑t Node.js v√† npm. B·∫°n c√≥ th·ªÉ ki·ªÉm tra phi√™n b·∫£n hi·ªán t·∫°i b·∫±ng c√°ch ch·∫°y:\n$ npm --version N·∫øu l·ªánh kh√¥ng ƒë∆∞·ª£c nh·∫≠n di·ªán, vui l√≤ng t·∫£i v√† c√†i ƒë·∫∑t Node.js t·ª´ nodejs.org\nC√†i ƒë·∫∑t dependencies Ch·∫°y l·ªánh sau ƒë·ªÉ c√†i ƒë·∫∑t t·∫•t c·∫£ c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt:\n$ npm install Build Project Sau khi c√†i ƒë·∫∑t ho√†n t·∫•t, ch·∫°y l·ªánh build:\n$ npm run build Sau khi ho√†n t·∫•t, m·ªôt th∆∞ m·ª•c dist s·∫Ω ƒë∆∞·ª£c t·∫°o ra ch·ª©a index.html v√† th∆∞ m·ª•c assets.\nC·∫•u h√¨nh Deployment Context Stack s·ª≠ d·ª•ng c√°c bi·∫øn context (context variables). C√°c bi·∫øn n√†y ƒë∆∞·ª£c ƒë·ªçc t·ª´ cdk.context.json ho·∫∑c cung c·∫•p qua c·ªù (flags) d√≤ng l·ªánh.\nVariable Name Description Required if functionality is desired Default Value (in cdk.context.json) vpc_ids Danh s√°ch c√°c VPC IDs cho Flow Logs v√† DNS Query Logging. C√≥ [] alert_email Danh s√°ch c√°c ƒë·ªãa ch·ªâ email cho th√¥ng b√°o c·∫£nh b√°o (y√™u c·∫ßu SES). C√≥ [] sender_email ƒê·ªãa ch·ªâ email ng∆∞·ªùi g·ª≠i SES ƒë√£ x√°c th·ª±c. C√≥ (n·∫øu alert_email ƒë∆∞·ª£c thi·∫øt l·∫≠p) \u0026quot;\u0026quot; slack_webhook_url Slack webhook URL ƒë·ªÉ g·ª≠i c·∫£nh b√°o. Kh√¥ng \u0026quot;\u0026quot; V√≠ d·ª•\n{ \u0026#34;vpc_ids\u0026#34;: [ \u0026#34;vpc-a1b2c3d4e5f6g7h8i\u0026#34; ], \u0026#34;alert_email\u0026#34;: [ \u0026#34;admin@example.com\u0026#34; ], \u0026#34;sender_email\u0026#34;: \u0026#34;alerts@your-domain.com\u0026#34;, \u0026#34;slack_webhook_url\u0026#34;: \u0026#34;\u0026#34; } Tri·ªÉn khai Stacks (Deploy) Tr∆∞·ªõc khi x·ª≠ l√Ω ti·∫øp, n·∫øu ƒëang ·ªü trong th∆∞ m·ª•c /react, nh·∫≠p l·ªánh n√†y ƒë·ªÉ quay l·∫°i th∆∞ m·ª•c ch√≠nh:\n$ cd.. CDK Bootstrapping: N·∫øu b·∫°n ch∆∞a t·ª´ng s·ª≠ d·ª•ng AWS CDK trong t√†i kho·∫£n AWS v√† region m·ª•c ti√™u tr∆∞·ªõc ƒë√¢y, ch·∫°y l·ªánh bootstrap m·ªôt l·∫ßn ƒë·ªÉ cung c·∫•p c√°c t√†i nguy√™n c·∫ßn thi·∫øt (v√≠ d·ª•: S3 deployment bucket).\n$ cdk bootstrap (T√πy ch·ªçn) Synthesize v√† Diff: Xem l·∫°i c√°c thay ƒë·ªïi CloudFormation ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t tr∆∞·ªõc khi deployment:\n$ cdk synth --all $ cdk diff --all Execute Deployment: Ch·∫°y l·ªánh deployment v√† ph√™ duy·ªát b·∫•t k·ª≥ thay ƒë·ªïi b·∫£o m·∫≠t IAM n√†o ƒë∆∞·ª£c y√™u c·∫ßu khi ƒë∆∞·ª£c nh·∫Øc.\n$ cdk deploy --all Vi·ªác deployment ho√†n t·∫•t khi CDK CLI b√°o c√°o th√†nh c√¥ng cho stack: AwsIncidentResponseAutomationCdkStack v√† DashboardCdkStack\nL∆ØU √ù QUAN TR·ªåNG: Sau khi deployment ho√†n t·∫•t, b·∫°n n√™n x√°c minh email trong SES. T·∫°o m·ªôt user trong Cognito ƒë·ªÉ c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o Dashboard. Truy c·∫≠p Security Group v√† x√≥a quy t·∫Øc outbound m·∫∑c ƒë·ªãnh kh·ªèi QuarantineSecurityGroup "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/10-cleanup/","title":"D·ªçn d·∫πp","tags":[],"description":"","content":"Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh workshop n√†y! Trong workshop n√†y, b·∫°n ƒë√£ t·∫°o m·ªôt H·ªá th·ªëng Ph·∫£n h·ªìi S·ª± c·ªë v√† ƒêi·ªÅu tra s·ªë T·ª± ƒë·ªông v√† l√†m quen v·ªõi Lambda, Step Functions, EventBridge, Glue, Athena, CloudFront, Cognito, S3 Buckets\nH∆∞·ªõng d·∫´n d·ªçn d·∫πp: H∆∞·ªõng d·∫´n d·ªçn d·∫πp cho thi·∫øt l·∫≠p th·ªß c√¥ng H∆∞·ªõng d·∫´n d·ªçn d·∫πp cho thi·∫øt l·∫≠p CDK "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/11.10-step-functions-state-machine-definition/","title":"M√£ ƒê·ªãnh nghƒ©a Step Functions ASL","tags":[],"description":"","content":" { \u0026#34;Comment\u0026#34;: \u0026#34;Guardduty Incident Response Automation\u0026#34;, \u0026#34;StartAt\u0026#34;: \u0026#34;CheckFindingType\u0026#34;, \u0026#34;States\u0026#34;: { \u0026#34;CheckFindingType\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Choice\u0026#34;, \u0026#34;Choices\u0026#34;: [ { \u0026#34;Comment\u0026#34;: \u0026#34;Check if EC2 (Ki·ªÉm tra n·∫øu l√† EC2)\u0026#34;, \u0026#34;Variable\u0026#34;: \u0026#34;$.detail.resource.resourceType\u0026#34;, \u0026#34;StringEquals\u0026#34;: \u0026#34;Instance\u0026#34;, \u0026#34;Next\u0026#34;: \u0026#34;ParseFindings\u0026#34; }, { \u0026#34;Comment\u0026#34;: \u0026#34;Check if IAM (Ki·ªÉm tra n·∫øu l√† IAM)\u0026#34;, \u0026#34;Variable\u0026#34;: \u0026#34;$.detail.resource.resourceType\u0026#34;, \u0026#34;StringEquals\u0026#34;: \u0026#34;AccessKey\u0026#34;, \u0026#34;Next\u0026#34;: \u0026#34;Quarantine_IAM_User\u0026#34; } ], \u0026#34;Default\u0026#34;: \u0026#34;NoActionNeeded\u0026#34; }, \u0026#34;ParseFindings\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::lambda:invoke\u0026#34;, \u0026#34;OutputPath\u0026#34;: \u0026#34;$.Payload\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;Payload.$\u0026#34;: \u0026#34;$\u0026#34;, \u0026#34;FunctionName\u0026#34;: \u0026#34;arn:aws:lambda:ap-southeast-1:831981618496:function:ir-parse-findings-lambda\u0026#34; }, \u0026#34;Retry\u0026#34;: [ { \u0026#34;ErrorEquals\u0026#34;: [ \u0026#34;Lambda.ServiceException\u0026#34;, \u0026#34;Lambda.AWSLambdaException\u0026#34;, \u0026#34;Lambda.SdkClientException\u0026#34;, \u0026#34;Lambda.TooManyRequestsException\u0026#34; ], \u0026#34;IntervalSeconds\u0026#34;: 1, \u0026#34;MaxAttempts\u0026#34;: 3, \u0026#34;BackoffRate\u0026#34;: 2, \u0026#34;JitterStrategy\u0026#34;: \u0026#34;FULL\u0026#34; } ], \u0026#34;Next\u0026#34;: \u0026#34;Isolate_EC2_Instance\u0026#34; }, \u0026#34;Isolate_EC2_Instance\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::lambda:invoke\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;FunctionName\u0026#34;: \u0026#34;arn:aws:lambda:ap-southeast-1:831981618496:function:ir-isolate-ec2-lambda\u0026#34;, \u0026#34;Payload\u0026#34;: { \u0026#34;InstanceId.$\u0026#34;: \u0026#34;$.InstanceIds[0]\u0026#34;, \u0026#34;Region.$\u0026#34;: \u0026#34;$.Region\u0026#34; } }, \u0026#34;Retry\u0026#34;: [ { \u0026#34;ErrorEquals\u0026#34;: [ \u0026#34;Lambda.TooManyRequestsException\u0026#34;, \u0026#34;Lambda.ServiceException\u0026#34;, \u0026#34;Lambda.AWSLambdaException\u0026#34;, \u0026#34;Lambda.SdkClientException\u0026#34; ], \u0026#34;IntervalSeconds\u0026#34;: 2, \u0026#34;MaxAttempts\u0026#34;: 3, \u0026#34;BackoffRate\u0026#34;: 2 } ], \u0026#34;Next\u0026#34;: \u0026#34;CheckIsolationStatus\u0026#34;, \u0026#34;OutputPath\u0026#34;: \u0026#34;$.Payload\u0026#34; }, \u0026#34;CheckIsolationStatus\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Choice\u0026#34;, \u0026#34;Choices\u0026#34;: [ { \u0026#34;Variable\u0026#34;: \u0026#34;$.IsolationSG\u0026#34;, \u0026#34;IsNull\u0026#34;: true, \u0026#34;Next\u0026#34;: \u0026#34;AlreadyIsolated\u0026#34; } ], \u0026#34;Default\u0026#34;: \u0026#34;EnableTerminationProtection\u0026#34; }, \u0026#34;AlreadyIsolated\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Succeed\u0026#34; }, \u0026#34;EnableTerminationProtection\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:ec2:modifyInstanceAttribute\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;InstanceId.$\u0026#34;: \u0026#34;$.InstanceId\u0026#34;, \u0026#34;DisableApiTermination\u0026#34;: { \u0026#34;Value\u0026#34;: true } }, \u0026#34;Next\u0026#34;: \u0026#34;CreateQuarantineTag\u0026#34;, \u0026#34;ResultPath\u0026#34;: null }, \u0026#34;CreateQuarantineTag\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:ec2:createTags\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;Resources.$\u0026#34;: \u0026#34;States.Array($.InstanceId)\u0026#34;, \u0026#34;Tags\u0026#34;: [ { \u0026#34;Key\u0026#34;: \u0026#34;Quarantine\u0026#34;, \u0026#34;Value\u0026#34;: \u0026#34;True\u0026#34; }, { \u0026#34;Key\u0026#34;: \u0026#34;Security Group\u0026#34;, \u0026#34;Value.$\u0026#34;: \u0026#34;$.IsolationSG\u0026#34; } ] }, \u0026#34;Next\u0026#34;: \u0026#34;DescribeInstanceASG\u0026#34;, \u0026#34;ResultPath\u0026#34;: null }, \u0026#34;DescribeInstanceASG\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:autoscaling:describeAutoScalingInstances\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;InstanceIds.$\u0026#34;: \u0026#34;States.Array($.InstanceId)\u0026#34; }, \u0026#34;ResultPath\u0026#34;: \u0026#34;$.ASGInfo\u0026#34;, \u0026#34;Next\u0026#34;: \u0026#34;CheckIfASGExists\u0026#34; }, \u0026#34;CheckIfASGExists\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Choice\u0026#34;, \u0026#34;Choices\u0026#34;: [ { \u0026#34;Variable\u0026#34;: \u0026#34;$.ASGInfo.AutoScalingInstances[0]\u0026#34;, \u0026#34;IsPresent\u0026#34;: true, \u0026#34;Next\u0026#34;: \u0026#34;UpdateASGConfiguration\u0026#34; } ], \u0026#34;Default\u0026#34;: \u0026#34;DescribeVolumes\u0026#34; }, \u0026#34;UpdateASGConfiguration\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:autoscaling:updateAutoScalingGroup\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;AutoScalingGroupName.$\u0026#34;: \u0026#34;$.ASGInfo.AutoScalingInstances[0].AutoScalingGroupName\u0026#34;, \u0026#34;MinSize\u0026#34;: 0 }, \u0026#34;ResultPath\u0026#34;: null, \u0026#34;Next\u0026#34;: \u0026#34;Wait for ASG\u0026#34; }, \u0026#34;Wait for ASG\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Wait\u0026#34;, \u0026#34;Seconds\u0026#34;: 10, \u0026#34;Next\u0026#34;: \u0026#34;DetachFromASG\u0026#34; }, \u0026#34;DetachFromASG\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:autoscaling:detachInstances\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;AutoScalingGroupName.$\u0026#34;: \u0026#34;$.ASGInfo.AutoScalingInstances[0].AutoScalingGroupName\u0026#34;, \u0026#34;InstanceIds.$\u0026#34;: \u0026#34;States.Array($.InstanceId)\u0026#34;, \u0026#34;ShouldDecrementDesiredCapacity\u0026#34;: false }, \u0026#34;Retry\u0026#34;: [ { \u0026#34;ErrorEquals\u0026#34;: [ \u0026#34;AutoScaling.ValidationException\u0026#34; ], \u0026#34;IntervalSeconds\u0026#34;: 15, \u0026#34;MaxAttempts\u0026#34;: 3, \u0026#34;BackoffRate\u0026#34;: 2 } ], \u0026#34;ResultPath\u0026#34;: null, \u0026#34;Next\u0026#34;: \u0026#34;DescribeVolumes\u0026#34; }, \u0026#34;DescribeVolumes\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:ec2:describeVolumes\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;Filters\u0026#34;: [ { \u0026#34;Name\u0026#34;: \u0026#34;attachment.instance-id\u0026#34;, \u0026#34;Values.$\u0026#34;: \u0026#34;States.Array($.InstanceId)\u0026#34; } ] }, \u0026#34;ResultPath\u0026#34;: \u0026#34;$.VolumeInfo\u0026#34;, \u0026#34;Next\u0026#34;: \u0026#34;CreateSnapshots\u0026#34; }, \u0026#34;CreateSnapshots\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Map\u0026#34;, \u0026#34;ItemsPath\u0026#34;: \u0026#34;$.VolumeInfo.Volumes\u0026#34;, \u0026#34;MaxConcurrency\u0026#34;: 1, \u0026#34;Iterator\u0026#34;: { \u0026#34;StartAt\u0026#34;: \u0026#34;Wait before calling CreateSnapshot API\u0026#34;, \u0026#34;States\u0026#34;: { \u0026#34;Wait before calling CreateSnapshot API\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Wait\u0026#34;, \u0026#34;Seconds\u0026#34;: 15, \u0026#34;Next\u0026#34;: \u0026#34;CreateSnapshot\u0026#34; }, \u0026#34;CreateSnapshot\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::aws-sdk:ec2:createSnapshot\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;VolumeId.$\u0026#34;: \u0026#34;$.VolumeId\u0026#34;, \u0026#34;Description.$\u0026#34;: \u0026#34;States.Format(\u0026#39;IR Snapshot for {} - {}\u0026#39;, $.Attachments[0].InstanceId, $.VolumeId)\u0026#34;, \u0026#34;TagSpecifications\u0026#34;: [ { \u0026#34;ResourceType\u0026#34;: \u0026#34;snapshot\u0026#34;, \u0026#34;Tags\u0026#34;: [ { \u0026#34;Key\u0026#34;: \u0026#34;Quarantine\u0026#34;, \u0026#34;Value\u0026#34;: \u0026#34;True\u0026#34; } ] } ] }, \u0026#34;Retry\u0026#34;: [ { \u0026#34;ErrorEquals\u0026#34;: [ \u0026#34;Ec2.RequestLimitExceeded\u0026#34; ], \u0026#34;IntervalSeconds\u0026#34;: 60, \u0026#34;MaxAttempts\u0026#34;: 3, \u0026#34;BackoffRate\u0026#34;: 2 } ], \u0026#34;End\u0026#34;: true } } }, \u0026#34;End\u0026#34;: true }, \u0026#34;Quarantine_IAM_User\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Choice\u0026#34;, \u0026#34;Choices\u0026#34;: [ { \u0026#34;Variable\u0026#34;: \u0026#34;$.detail.resource.accessKeyDetails.userType\u0026#34;, \u0026#34;StringEquals\u0026#34;: \u0026#34;Root\u0026#34;, \u0026#34;Next\u0026#34;: \u0026#34;RootUserDetected\u0026#34; } ], \u0026#34;Default\u0026#34;: \u0026#34;ExecuteIAMQuarantine\u0026#34; }, \u0026#34;RootUserDetected\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Succeed\u0026#34;, \u0026#34;Comment\u0026#34;: \u0026#34;Cannot quarantine root user\u0026#34; }, \u0026#34;ExecuteIAMQuarantine\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Task\u0026#34;, \u0026#34;Resource\u0026#34;: \u0026#34;arn:aws:states:::lambda:invoke\u0026#34;, \u0026#34;Parameters\u0026#34;: { \u0026#34;FunctionName\u0026#34;: \u0026#34;arn:aws:lambda:ap-southeast-1:831981618496:function:ir-quarantine-iam-lambda\u0026#34;, \u0026#34;Payload.$\u0026#34;: \u0026#34;$\u0026#34; }, \u0026#34;Retry\u0026#34;: [ { \u0026#34;ErrorEquals\u0026#34;: [ \u0026#34;Lambda.TooManyRequestsException\u0026#34;, \u0026#34;Lambda.ServiceException\u0026#34;, \u0026#34;Lambda.AWSLambdaException\u0026#34;, \u0026#34;Lambda.SdkClientException\u0026#34; ], \u0026#34;IntervalSeconds\u0026#34;: 2, \u0026#34;MaxAttempts\u0026#34;: 3, \u0026#34;BackoffRate\u0026#34;: 2 } ], \u0026#34;End\u0026#34;: true }, \u0026#34;NoActionNeeded\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;Succeed\u0026#34; } } } "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/11-appendices/","title":"Ph·ª• l·ª•c","tags":[],"description":"","content":"Ph·ª• l·ª•c Lambda Codes: CloudTrail ETL GuardDuty ETL CloudWatch ETL CloudWatch ENI ETL CloudWatch Auto Export Parse Findings Isolate EC2 Instance Quarantine IAM Alert Dispatch Step Functions ASL Code: Step Functions ASL Code "},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/categories/","title":"Categories","tags":[],"description":"","content":""},{"uri":"https://aws-incident-response-automation-cdk.github.io/aws-incident-response-automation-workshop/vi/tags/","title":"Tags","tags":[],"description":"","content":""}]